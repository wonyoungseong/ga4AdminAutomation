{% extends "base.html" %}

{% block title %}사용자 등록 - GA4 권한 관리 시스템{% endblock %}
{% block page_title %}사용자 등록{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-person-plus"></i>
                    새 사용자 등록
                </h5>
            </div>
            <div class="card-body">
                <form id="registrationForm">
                    <!-- 신청자 정보 -->
                    <div class="mb-3">
                        <label for="신청자" class="form-label">신청자 *</label>
                        <input type="text" class="form-control" id="신청자" name="신청자" required
                               placeholder="권한을 신청하는 담당자명을 입력하세요">
                        <div class="form-text">예: 홍길동 (아모레퍼시픽 마케팅팀)</div>
                    </div>

                    <!-- 등록할 계정 목록 -->
                    <div class="mb-3">
                        <label for="등록_계정_목록" class="form-label">등록할 계정 목록 *</label>
                        <textarea class="form-control" id="등록_계정_목록" name="등록_계정_목록" rows="4" required
                                  placeholder="등록할 이메일 주소를 쉼표로 구분하여 입력하세요"></textarea>
                        <div class="form-text">
                            예: user1@company.com, user2@company.com, user3@company.com<br>
                            또는 한 줄에 하나씩 입력하세요.
                        </div>
                    </div>

                    <!-- 권한 선택 -->
                    <div class="mb-3">
                        <label class="form-label">권한 레벨 *</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="권한" id="analyst" value="analyst" checked>
                                            <label class="form-check-label" for="analyst">
                                                <strong>Analyst</strong>
                                            </label>
                                        </div>
                                        <small class="text-muted">
                                            • 데이터 조회 및 분석 가능<br>
                                            • 30일 만료 (연장 가능)<br>
                                            • 자동 승인
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="권한" id="editor" value="editor">
                                            <label class="form-check-label" for="editor">
                                                <strong>Editor</strong>
                                            </label>
                                        </div>
                                        <small class="text-muted">
                                            • 데이터 수정 및 설정 변경 가능<br>
                                            • 7일 만료 (연장 불가)<br>
                                            • <span class="text-warning">수동 승인 필요</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card border-danger">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="권한" id="admin" value="admin">
                                            <label class="form-check-label" for="admin">
                                                <strong class="text-danger">Admin</strong>
                                            </label>
                                        </div>
                                        <small class="text-muted">
                                            • 사용자 관리 및 권한 부여<br>
                                            • 계정 설정 및 구성 관리<br>
                                            • 7일 만료 (연장 불가)<br>
                                            • <span class="text-danger">신중한 검토 후 승인</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 프로퍼티 선택 -->
                    <div class="mb-3">
                        <label class="form-label">등록할 프로퍼티 *</label>
                        {% if properties %}
                        <div class="row" id="propertyList">
                            {% for property in properties %}
                            <div class="col-md-6 mb-2">
                                <div class="card">
                                    <div class="card-body p-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="property_ids" 
                                                   value="{{ property.property_id }}" id="property_{{ property.property_id }}">
                                            <label class="form-check-label" for="property_{{ property.property_id }}">
                                                <strong>{{ property.property_display_name }}</strong><br>
                                                <small class="text-muted">{{ property.account_display_name }}</small><br>
                                                <small class="text-muted">ID: {{ property.property_id }}</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllProperties()">
                                <i class="bi bi-check-all"></i> 전체 선택
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllProperties()">
                                <i class="bi bi-x"></i> 전체 해제
                            </button>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            등록 가능한 프로퍼티가 없습니다. 
                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="scanProperties()">
                                <i class="bi bi-arrow-clockwise"></i> 프로퍼티 스캔
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- 제출 버튼 -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="bi bi-person-plus"></i>
                            사용자 등록
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 등록 결과 -->
        <div id="registrationResults" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle"></i>
                        등록 결과
                    </h5>
                </div>
                <div class="card-body" id="resultsContent">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 도움말 카드 -->
<div class="row mt-4">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-question-circle"></i>
                    사용법 안내
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>권한 레벨</h6>
                        <ul class="small">
                            <li><strong>Analyst:</strong> 일반적인 데이터 분석 권한 (30일)</li>
                            <li><strong>Editor:</strong> Google Ads 연결 등 특수 목적 (7일, 승인 필요)</li>
                            <li><strong class="text-danger">Admin:</strong> 사용자 관리, 계정 설정 등 최고 권한 (7일, 승인 필요)</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>이메일 입력 방법</h6>
                        <ul class="small">
                            <li>쉼표로 구분: <code>a@company.com, b@company.com</code></li>
                            <li>줄바꿈으로 구분: 한 줄에 하나씩</li>
                            <li>공백은 자동으로 제거됩니다</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('registrationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        
        // 버튼 비활성화 및 로딩 표시
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>등록 중...';
        
        try {
            // 폼 데이터 수집
            const formData = new FormData(this);
            
            // 선택된 프로퍼티 확인
            const selectedProperties = document.querySelectorAll('input[name="property_ids"]:checked');
            if (selectedProperties.length === 0) {
                throw new Error('최소 하나의 프로퍼티를 선택해주세요.');
            }
            
            // 이메일 목록 처리
            const emailText = formData.get('등록_계정_목록').trim();
            if (!emailText) {
                throw new Error('등록할 계정을 입력해주세요.');
            }
            
            // API 호출
            const response = await fetch('/api/register', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showRegistrationResults(data.results);
                showAlert(data.message, 'success');
                
                // 폼 초기화
                this.reset();
                clearAllProperties();
            } else {
                throw new Error(data.message || '등록에 실패했습니다.');
            }
            
        } catch (error) {
            showAlert('등록 실패: ' + error.message, 'danger');
        } finally {
            // 버튼 복원
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
    
    function selectAllProperties() {
        const checkboxes = document.querySelectorAll('input[name="property_ids"]');
        checkboxes.forEach(cb => cb.checked = true);
    }
    
    function clearAllProperties() {
        const checkboxes = document.querySelectorAll('input[name="property_ids"]');
        checkboxes.forEach(cb => cb.checked = false);
    }
    
    function showRegistrationResults(results) {
        const resultsDiv = document.getElementById('registrationResults');
        const contentDiv = document.getElementById('resultsContent');
        
        // 안전한 results 배열 처리
        if (!results || !Array.isArray(results)) {
            contentDiv.innerHTML = '<div class="alert alert-warning">등록 결과를 표시할 수 없습니다.</div>';
            resultsDiv.style.display = 'block';
            return;
        }
        
        let successCount = 0;
        let errorCount = 0;
        let html = '<div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th>이메일</th><th>프로퍼티 ID</th><th>상태</th><th>비고</th></tr></thead><tbody>';
        
        results.forEach(result => {
            if (result.status === 'success') {
                successCount++;
                html += `<tr class="table-success">
                    <td>${result.email}</td>
                    <td>${result.property_id}</td>
                    <td><i class="bi bi-check-circle text-success"></i> 성공</td>
                    <td>등록 ID: ${result.registration_id}</td>
                </tr>`;
            } else {
                errorCount++;
                html += `<tr class="table-danger">
                    <td>${result.email}</td>
                    <td>${result.property_id}</td>
                    <td><i class="bi bi-x-circle text-danger"></i> 실패</td>
                    <td>${result.error}</td>
                </tr>`;
            }
        });
        
        html += '</tbody></table></div>';
        html += `<div class="mt-2">
            <span class="badge bg-success me-2">성공: ${successCount}건</span>
            <span class="badge bg-danger">실패: ${errorCount}건</span>
        </div>`;
        
        contentDiv.innerHTML = html;
        resultsDiv.style.display = 'block';
        
        // 결과로 스크롤
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
    }
    
    // 이메일 입력 시 자동 포맷팅
    document.getElementById('등록_계정_목록').addEventListener('blur', function() {
        const value = this.value.trim();
        if (value) {
            // 줄바꿈과 쉼표를 모두 쉼표로 통일
            const emails = value.split(/[,\n]/).map(email => email.trim()).filter(email => email);
            this.value = emails.join(', ');
        }
    });
</script>
{% endblock %} 