{% extends "base.html" %}

{% block title %}GA4 ê¶Œí•œ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block content %}
<div class="container-fluid dashboard">
    <!-- ì‹œìŠ¤í…œ ìƒíƒœ ì¹´ë“œ -->
    <div class="row mb-4">
        <div class="col-12 mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h4>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-sm" onclick="showStats('dashboard')">
                        <i class="bi bi-arrow-clockwise"></i> ë””ë²„ê¹… ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshStats()">
                        <i class="bi bi-arrow-clockwise"></i> ì¼ë°˜ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">ì´ ê³„ì •</h5>
                    <h2 class="card-text" id="total-accounts-card">{{ stats.total_accounts if stats and stats.total_accounts is defined else 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">ì´ í”„ë¡œí¼í‹°</h5>
                    <h2 class="card-text" id="total-properties-card">{{ stats.total_properties if stats and stats.total_properties is defined else 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">í™œì„± ì‚¬ìš©ì</h5>
                    <h2 class="card-text" id="active-users-card">{{ stats.active_users if stats and stats.active_users is defined else 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">ë§Œë£Œ ì˜ˆì •</h5>
                    <h2 class="card-text" id="expiring-soon-card">{{ stats.expiring_soon if stats and stats.expiring_soon is defined else 0 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ¤– ìë™í™” ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ</h5>
                    <div id="scheduler-status-badge" class="badge bg-secondary">í™•ì¸ ì¤‘...</div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ìƒíƒœ:</strong> <span id="scheduler-running-status">í™•ì¸ ì¤‘...</span></p>
                            <p><strong>ë§ˆì§€ë§‰ ì‹¤í–‰:</strong> <span id="scheduler-last-run">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group" role="group">
                                <button class="btn btn-success btn-sm" onclick="startScheduler()">ì‹œì‘</button>
                                <button class="btn btn-danger btn-sm" onclick="stopScheduler()">ì¤‘ì§€</button>
                                <button class="btn btn-info btn-sm" onclick="refreshSchedulerStatus()">ìƒˆë¡œê³ ì¹¨</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê´€ë¦¬ ë„êµ¬ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ› ï¸ ê´€ë¦¬ ë„êµ¬</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- ê¸°ì¡´ ê´€ë¦¬ ë„êµ¬ë“¤ -->
                        <div class="col-md-6 mb-3">
                            <h6>ğŸ“Š ë°ì´í„° ê´€ë¦¬</h6>
                            <div class="btn-group-vertical d-grid gap-2">
                                <button class="btn btn-primary" onclick="scanProperties()">í”„ë¡œí¼í‹° ìŠ¤ìº”</button>
                                <button class="btn btn-success" onclick="processQueue()">ë“±ë¡ ëŒ€ê¸°ì—´ ì²˜ë¦¬</button>
                                <button class="btn btn-warning" onclick="processExpiration()">ë§Œë£Œ ì²˜ë¦¬</button>
                            </div>
                        </div>
                        
                        <!-- ìƒˆë¡œìš´ ì•Œë¦¼ ê´€ë¦¬ ë„êµ¬ë“¤ -->
                        <div class="col-md-4 mb-3">
                            <h6>ğŸ“§ ì•Œë¦¼ ê´€ë¦¬</h6>
                            <div class="btn-group-vertical d-grid gap-2">
                                <button class="btn btn-info" onclick="processExpiryNotifications()">ë§Œë£Œ ì•Œë¦¼ ë°œì†¡</button>
                                <button class="btn btn-secondary" onclick="processEditorDowngrade()">Editor ê¶Œí•œ ë‹¤ìš´ê·¸ë ˆì´ë“œ</button>
                                <button class="btn btn-danger" onclick="processAdminDowngrade()">Admin ê¶Œí•œ ë‹¤ìš´ê·¸ë ˆì´ë“œ</button>
                                <button class="btn btn-outline-primary" onclick="showTestNotificationModal()">í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡</button>
                                <button class="btn btn-outline-danger" onclick="processExpiredUsers()">ğŸ—‘ï¸ ë§Œë£Œ ì‚¬ìš©ì ì‚­ì œ</button>
                            </div>
                        </div>
                        
                        <!-- Editor ìŠ¹ì¸ ê´€ë¦¬ -->
                        <div class="col-md-4 mb-3">
                            <h6>ğŸ” Editor ê¶Œí•œ ê´€ë¦¬</h6>
                            <div class="btn-group-vertical d-grid gap-2">
                                <button class="btn btn-success" onclick="showEditorApprovalModal()">âœ… Editor ìŠ¹ì¸ í…ŒìŠ¤íŠ¸</button>
                                <button class="btn btn-warning" onclick="viewPendingEditorRequests()">â³ ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡</button>
                                <button class="btn btn-info" onclick="testEditorApprovalFlow()">ğŸ§ª ì™„ì „í•œ ìŠ¹ì¸ í”Œë¡œìš°</button>
                            </div>
                        </div>
                        
                        <!-- Admin ìŠ¹ì¸ ê´€ë¦¬ -->
                        <div class="col-md-4 mb-3">
                            <h6>ğŸ” Admin ê¶Œí•œ ê´€ë¦¬</h6>
                            <div class="btn-group-vertical d-grid gap-2">
                                <button class="btn btn-danger" onclick="showAdminApprovalModal()">âœ… Admin ìŠ¹ì¸ í…ŒìŠ¤íŠ¸</button>
                                <button class="btn btn-warning" onclick="viewPendingAdminRequests()">â³ ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡</button>
                                <button class="btn btn-outline-danger" onclick="testAdminApprovalFlow()">ğŸ§ª ì™„ì „í•œ ìŠ¹ì¸ í”Œë¡œìš°</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ í†µê³„ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“ˆ ì•Œë¦¼ í†µê³„</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshNotificationStats()">ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div class="card-body">
                    <div class="row" id="notification-stats">
                        <div class="col-12 text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‹œìŠ¤í…œ ì •ë³´ ì„¹ì…˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ğŸ“Š ì‹œìŠ¤í…œ ì •ë³´</h5>
                    <div id="system-info">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>ê³„ì •:</strong> {{ stats.total_accounts if stats and stats.total_accounts is defined else 0 }}ê°œ<br>
                                <strong>í”„ë¡œí¼í‹°:</strong> {{ stats.total_properties if stats and stats.total_properties is defined else 0 }}ê°œ<br>
                                <strong>í™œì„± ì‚¬ìš©ì:</strong> {{ stats.active_users if stats and stats.active_users is defined else 0 }}ëª…
                            </div>
                            <div class="col-md-6">
                                <strong>ë§Œë£Œ ì˜ˆì •:</strong> {{ stats.expiring_soon if stats and stats.expiring_soon is defined else 0 }}ëª…<br>
                                <strong>ì´ ì•Œë¦¼:</strong> {{ stats.total_notifications if stats and stats.total_notifications is defined else 0 }}ê°œ<br>
                                <strong>ë“±ë¡:</strong> {{ stats.total_registrations if stats and stats.total_registrations is defined else 0 }}ê°œ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê¸°ì¡´ í…Œì´ë¸”ë“¤ -->
    <!-- GA4 ê³„ì • ëª©ë¡ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ¢ GA4 ê³„ì • ëª©ë¡</h5>
                </div>
                <div class="card-body">
                    {% if accounts %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ê³„ì •ëª…</th>
                                    <th>ê³„ì • ID</th>
                                    <th>í‘œì‹œëª…</th>
                                    <th>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for account in accounts %}
                                <tr>
                                    <td>{{ account.account_name }}</td>
                                    <td><code>{{ account.account_id }}</code></td>
                                    <td>{{ account.display_name }}</td>
                                    <td>{{ account.last_updated[:19] if account.last_updated else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">ë“±ë¡ëœ GA4 ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- GA4 í”„ë¡œí¼í‹° ëª©ë¡ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ  GA4 í”„ë¡œí¼í‹° ëª©ë¡</h5>
                </div>
                <div class="card-body">
                    {% if properties %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>í”„ë¡œí¼í‹°ëª…</th>
                                    <th>í”„ë¡œí¼í‹° ID</th>
                                    <th>ê³„ì •</th>
                                    <th>íƒ€ì„ì¡´</th>
                                    <th>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for property in properties %}
                                <tr>
                                    <td>{{ property.property_name }}</td>
                                    <td><code>{{ property.property_id }}</code></td>
                                    <td>{{ property.account_name }}</td>
                                    <td>{{ property.time_zone }}</td>
                                    <td>{{ property.last_updated[:19] if property.last_updated else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">ë“±ë¡ëœ GA4 í”„ë¡œí¼í‹°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¼ ì „ì†¡ ì´ë ¥ ê´€ë¦¬ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“§ ë©”ì¼ ì „ì†¡ ì´ë ¥</h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshNotificationLogs()">
                            <i class="bi bi-arrow-clockwise"></i> ìƒˆë¡œê³ ì¹¨
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="clearTodayNotificationLogs()">
                            <i class="bi bi-calendar-x"></i> ì˜¤ëŠ˜ ì´ë ¥ ì‚­ì œ
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearAllNotificationLogs()">
                            <i class="bi bi-trash"></i> ì „ì²´ ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="email" class="form-control" id="specificEmail" placeholder="íŠ¹ì • ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-info w-100" onclick="clearSpecificEmailLogs()">
                                <i class="bi bi-person-x"></i> ì´ ì´ë©”ì¼ ì´ë ¥ ì‚­ì œ
                            </button>
                        </div>
                    </div>
                    
                    <div id="notification-logs-container">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ë“±ë¡ í˜„í™© -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ‘¥ ì‚¬ìš©ì ë“±ë¡ í˜„í™©</h5>
                    <a href="/register" class="btn btn-primary btn-sm">ìƒˆ ì‚¬ìš©ì ë“±ë¡</a>
                </div>
                <div class="card-body">
                    {% if registrations %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ì‚¬ìš©ì</th>
                                    <th>ì´ë©”ì¼</th>
                                    <th>í”„ë¡œí¼í‹°</th>
                                    <th>ê¶Œí•œ</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ë“±ë¡ì¼</th>
                                    <th>ë§Œë£Œì¼</th>
                                    <th>GA4 ë“±ë¡</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reg in registrations %}
                                <tr>
                                    <td>{{ reg.applicant }}</td>
                                    <td>{{ reg.user_email }}</td>
                                    <td>{{ reg.property_name }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'warning' if reg.permission_level == 'editor' else 'info' }}">
                                            {{ reg.permission_level }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if reg.status == 'active' else 'warning' if reg.status == 'pending_approval' else 'secondary' }}">
                                            {{ reg.status }}
                                        </span>
                                    </td>
                                    <td>{{ reg.created_at[:19] if reg.created_at else '-' }}</td>
                                    <td>{{ reg.expiry_date[:19] if reg.expiry_date else '-' }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if reg.ga4_registered else 'danger' }}">
                                            {{ 'ë“±ë¡ë¨' if reg.ga4_registered else 'ë¯¸ë“±ë¡' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if reg.status == 'pending_approval' %}
                                        <button class="btn btn-sm btn-success me-1" onclick="approveRegistration('{{ reg.id }}')">ìŠ¹ì¸</button>
                                        <button class="btn btn-sm btn-danger" onclick="rejectRegistration('{{ reg.id }}')">ê±°ë¶€</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ëª¨ë‹¬ -->
<div class="modal fade" id="testNotificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testNotificationForm">
                    <div class="mb-3">
                        <label for="testEmail" class="form-label">ì´ë©”ì¼ ì£¼ì†Œ</label>
                        <input type="email" class="form-control" id="testEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="testNotificationType" class="form-label">ì•Œë¦¼ íƒ€ì…</label>
                        <select class="form-select" id="testNotificationType">
                            <option value="welcome">í™˜ì˜ ì´ë©”ì¼</option>
                            <option value="expiry_warning_30">30ì¼ ë§Œë£Œ ì•Œë¦¼</option>
                            <option value="expiry_warning_7">7ì¼ ë§Œë£Œ ì•Œë¦¼</option>
                            <option value="expiry_warning_1">1ì¼ ë§Œë£Œ ì•Œë¦¼</option>
                            <option value="expiry_today">ë‹¹ì¼ ë§Œë£Œ ì•Œë¦¼</option>
                            <option value="deletion_notice">ì‚­ì œ ì•Œë¦¼</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="sendTestNotification()">ë°œì†¡</button>
            </div>
        </div>
    </div>
</div>

<!-- Editor ìŠ¹ì¸ í…ŒìŠ¤íŠ¸ ëª¨ë‹¬ -->
<div class="modal fade" id="editorApprovalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editor ê¶Œí•œ ìŠ¹ì¸ í…ŒìŠ¤íŠ¸</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editorApprovalForm">
                    <div class="mb-3">
                        <label for="editorApprovalEmail" class="form-label">ì´ë©”ì¼ ì£¼ì†Œ</label>
                        <input type="email" class="form-control" id="editorApprovalEmail" placeholder="editor@example.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="editorApprovalType" class="form-label">í…ŒìŠ¤íŠ¸ íƒ€ì…</label>
                        <select class="form-select" id="editorApprovalType">
                            <option value="test">í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ë©”ì¼ë§Œ ë°œì†¡)</option>
                            <option value="real">ì‹¤ì œ ìŠ¹ì¸ (DB ì—…ë°ì´íŠ¸ + ë©”ì¼ ë°œì†¡)</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <strong>í…ŒìŠ¤íŠ¸ ëª¨ë“œ:</strong> ì‹¤ì œ DB ë³€ê²½ ì—†ì´ ìŠ¹ì¸ ë©”ì¼ë§Œ ë°œì†¡<br>
                        <strong>ì‹¤ì œ ìŠ¹ì¸:</strong> DBì—ì„œ ê¶Œí•œì„ active/editorë¡œ ë³€ê²½í•˜ê³  ë©”ì¼ ë°œì†¡
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="executeEditorApproval()">ìŠ¹ì¸ ì‹¤í–‰</button>
            </div>
        </div>
    </div>
</div>

<!-- Admin ìŠ¹ì¸ í…ŒìŠ¤íŠ¸ ëª¨ë‹¬ -->
<div class="modal fade" id="adminApprovalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Admin ê¶Œí•œ ìŠ¹ì¸ í…ŒìŠ¤íŠ¸</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>ì£¼ì˜:</strong> Admin ê¶Œí•œì€ ìµœê³  ê¶Œí•œì…ë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ìŠ¹ì¸í•˜ì„¸ìš”.
                </div>
                <form id="adminApprovalForm">
                    <div class="mb-3">
                        <label for="adminApprovalEmail" class="form-label">ì´ë©”ì¼ ì£¼ì†Œ</label>
                        <input type="email" class="form-control" id="adminApprovalEmail" placeholder="admin@example.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="adminApprovalType" class="form-label">í…ŒìŠ¤íŠ¸ íƒ€ì…</label>
                        <select class="form-select" id="adminApprovalType">
                            <option value="test">í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ë©”ì¼ë§Œ ë°œì†¡)</option>
                            <option value="real">ì‹¤ì œ ìŠ¹ì¸ (DB ì—…ë°ì´íŠ¸ + ë©”ì¼ ë°œì†¡)</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <strong>í…ŒìŠ¤íŠ¸ ëª¨ë“œ:</strong> ì‹¤ì œ DB ë³€ê²½ ì—†ì´ ìŠ¹ì¸ ë©”ì¼ë§Œ ë°œì†¡<br>
                        <strong>ì‹¤ì œ ìŠ¹ì¸:</strong> DBì—ì„œ ê¶Œí•œì„ active/adminìœ¼ë¡œ ë³€ê²½í•˜ê³  ë©”ì¼ ë°œì†¡ (7ì¼ ìœ ì§€)
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-danger" onclick="executeAdminApproval()">ìŠ¹ì¸ ì‹¤í–‰</button>
            </div>
        </div>
    </div>
</div>

<!-- ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ëª¨ë‹¬ -->
<div class="modal fade" id="pendingRequestsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ Editor ìš”ì²­</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="pending-requests-container">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-outline-primary" onclick="loadPendingRequests()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>
    </div>
</div>

<!-- Admin ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ëª¨ë‹¬ -->
<div class="modal fade" id="pendingAdminRequestsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ Admin ìš”ì²­</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="pending-admin-requests-container">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-outline-primary" onclick="loadPendingAdminRequests()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>
    </div>
</div>

<script>
// ê¸°ì¡´ JavaScript í•¨ìˆ˜ë“¤...
async function scanProperties() {
    showLoading('í”„ë¡œí¼í‹° ìŠ¤ìº” ì¤‘...');
    try {
        const response = await fetch('/api/scan', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            const scanResult = result.result;
            showAlert('success', `ìŠ¤ìº” ì™„ë£Œ - ê³„ì •: ${scanResult.accounts_found}ê°œ, í”„ë¡œí¼í‹°: ${scanResult.properties_found}ê°œ`);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', result.error || 'í”„ë¡œí¼í‹° ìŠ¤ìº”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        showAlert('danger', 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        hideLoading();
    }
}

async function processQueue() {
    showLoading('ë“±ë¡ ëŒ€ê¸°ì—´ ì²˜ë¦¬ ì¤‘...');
    try {
        const response = await fetch('/api/process-queue', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', result.error || 'ëŒ€ê¸°ì—´ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        showAlert('danger', 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        hideLoading();
    }
}

async function processExpiration() {
    if (!confirm('ë§Œë£Œ ì²˜ë¦¬ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    showLoading('ë§Œë£Œ ì²˜ë¦¬ ì¤‘...');
    try {
        const response = await fetch('/api/process-expiry-notifications', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', result.error || 'ë§Œë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        showAlert('danger', 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        hideLoading();
    }
}

// ìƒˆë¡œìš´ JavaScript í•¨ìˆ˜ë“¤...
async function processExpiryNotifications() {
    showLoading('ë§Œë£Œ ì•Œë¦¼ ë°œì†¡ ì¤‘...');
    try {
        const response = await fetch('/api/process-expiry-notifications', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            refreshNotificationStats();
        } else {
            showAlert('danger', result.error || 'ë§Œë£Œ ì•Œë¦¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        showAlert('danger', 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        hideLoading();
    }
}

async function processEditorDowngrade() {
    if (!confirm('Editor ê¶Œí•œ ë‹¤ìš´ê·¸ë ˆì´ë“œë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    showLoading('Editor ë‹¤ìš´ê·¸ë ˆì´ë“œ ì²˜ë¦¬ ì¤‘...');
    try {
        const response = await fetch('/api/process-editor-downgrade', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', result.error || 'Editor ë‹¤ìš´ê·¸ë ˆì´ë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        showAlert('danger', 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        hideLoading();
    }
}

async function processAdminDowngrade() {
    if (!confirm('Admin ê¶Œí•œ ë‹¤ìš´ê·¸ë ˆì´ë“œë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ëª¨ë“  Admin ì‚¬ìš©ìë¥¼ Viewerë¡œ ë³€ê²½í•©ë‹ˆë‹¤.')) return;
    
    showLoading('Admin ë‹¤ìš´ê·¸ë ˆì´ë“œ ì²˜ë¦¬ ì¤‘...');
    try {
        const response = await fetch('/api/process-admin-downgrade', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', result.error || 'Admin ë‹¤ìš´ê·¸ë ˆì´ë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        showAlert('danger', 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        hideLoading();
    }
}

function showTestNotificationModal() {
    const modal = new bootstrap.Modal(document.getElementById('testNotificationModal'));
    modal.show();
}

async function sendTestNotification() {
    const email = document.getElementById('testEmail').value.trim();
    const type = document.getElementById('testNotificationType').value;
    
    if (!email) {
        showAlert('warning', 'ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        showLoading('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡ ì¤‘...');
        
        // ëª¨ë‹¬ ë‹«ê¸°
        const modal = bootstrap.Modal.getInstance(document.getElementById('testNotificationModal'));
        if (modal) {
            modal.hide();
        }
        
        const response = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: email,
                notification_type: type
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨');
        }
        
        showAlert('success', data.message);
        
        // ë©”ì¼ ì „ì†¡ ì´ë ¥ ìƒˆë¡œê³ ì¹¨
        setTimeout(async () => {
            await refreshNotificationLogs();
        }, 1000);
        
    } catch (error) {
        console.error('âŒ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨:', error);
        showAlert('danger', `í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function refreshNotificationStats() {
    try {
        const response = await fetch('/api/notification-stats');
        const result = await response.json();
        
        if (result.success && result.data) {
            const stats = result.data;
            const statsHtml = `
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-primary">${stats.total_sent || 0}</h4>
                        <small class="text-muted">ì´ ë°œì†¡</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-success">${stats.today_sent || 0}</h4>
                        <small class="text-muted">ì˜¤ëŠ˜ ë°œì†¡</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-warning">${stats.pending_notifications || 0}</h4>
                        <small class="text-muted">ëŒ€ê¸° ì¤‘</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-info">${stats.last_sent || 'ì—†ìŒ'}</h4>
                        <small class="text-muted">ë§ˆì§€ë§‰ ë°œì†¡</small>
                    </div>
                </div>
            `;
            const notificationStatsElement = document.getElementById('notification-stats');
            if (notificationStatsElement) {
                notificationStatsElement.innerHTML = statsHtml;
            }
            console.log('âœ… ì•Œë¦¼ í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', stats);
        } else {
            console.error('âŒ ì•Œë¦¼ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨:', result);
            // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ í‘œì‹œ
            const notificationStatsElement = document.getElementById('notification-stats');
            if (notificationStatsElement) {
                notificationStatsElement.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">ì•Œë¦¼ í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('âŒ ì•Œë¦¼ í†µê³„ ì¡°íšŒ ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ í‘œì‹œ
        const notificationStatsElement = document.getElementById('notification-stats');
        if (notificationStatsElement) {
            notificationStatsElement.innerHTML = `
                <div class="col-12 text-center">
                    <p class="text-danger">ì•Œë¦¼ í†µê³„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                </div>
            `;
        }
    }
}

async function refreshSchedulerStatus() {
    try {
        const response = await fetch('/api/scheduler-status');
        const result = await response.json();
        
        if (result.success && result.data) {
            const status = result.data;
            const isRunning = status.is_running;
            
            // ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
            const statusBadge = document.getElementById('scheduler-status-badge');
            if (statusBadge) {
                statusBadge.className = `badge ${isRunning ? 'bg-success' : 'bg-danger'}`;
                statusBadge.textContent = isRunning ? 'ì‹¤í–‰ ì¤‘' : 'ì¤‘ì§€ë¨';
            }
            
            // ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const runningStatus = document.getElementById('scheduler-running-status');
            if (runningStatus) {
                runningStatus.textContent = isRunning ? 'ì‹¤í–‰ ì¤‘' : 'ì¤‘ì§€ë¨';
            }
            
            // ë§ˆì§€ë§‰ ì‹¤í–‰ ì‹œê°„ ì—…ë°ì´íŠ¸
            const lastRun = document.getElementById('scheduler-last-run');
            if (lastRun) {
                lastRun.textContent = status.last_run || 'ì—†ìŒ';
            }
            
            console.log('âœ… ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', status);
        } else {
            console.error('âŒ ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', result);
        }
    } catch (error) {
        console.error('âŒ ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
        const statusBadge = document.getElementById('scheduler-status-badge');
        if (statusBadge) {
            statusBadge.className = 'badge bg-secondary';
            statusBadge.textContent = 'ì˜¤ë¥˜';
        }
    }
}

async function startScheduler() {
    showLoading('ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘ ì¤‘...');
    try {
        const response = await fetch('/api/scheduler/start', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            refreshSchedulerStatus();
        } else {
            showAlert('danger', result.error || 'ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        showAlert('danger', 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        hideLoading();
    }
}

async function stopScheduler() {
    showLoading('ìŠ¤ì¼€ì¤„ëŸ¬ ì¤‘ì§€ ì¤‘...');
    try {
        const response = await fetch('/api/scheduler/stop', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            refreshSchedulerStatus();
        } else {
            showAlert('danger', result.error || 'ìŠ¤ì¼€ì¤„ëŸ¬ ì¤‘ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        showAlert('danger', 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        hideLoading();
    }
}

async function approveRegistration(registrationId) {
    if (!confirm('ì´ ë“±ë¡ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    console.log('ğŸ”„ ìŠ¹ì¸ ì²˜ë¦¬ ì‹œì‘ - ë“±ë¡ ID:', registrationId);
    showLoading('ë“±ë¡ ìŠ¹ì¸ ì¤‘...');
    
    try {
        console.log('ğŸ“¡ ìŠ¹ì¸ API í˜¸ì¶œ ì‹œì‘');
        const response = await fetch(`/api/approve/${registrationId}`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('ğŸ“¡ ìŠ¹ì¸ API ì‘ë‹µ ìƒíƒœ:', response.status, response.ok);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('ğŸ“¡ ìŠ¹ì¸ API ì‘ë‹µ ë°ì´í„°:', result);
        
        if (result.success) {
            console.log('âœ… ìŠ¹ì¸ ì„±ê³µ:', result.message);
            showAlert('success', result.message || 'ë“±ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // ë„¤íŠ¸ì›Œí¬ í†µì‹  ì™„ë£Œ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
            console.log('ğŸ”„ ìŠ¹ì¸ ì™„ë£Œ - 2ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨');
            setTimeout(() => {
                console.log('ğŸ”„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰');
                location.reload();
            }, 2000);
        } else {
            console.error('âŒ ìŠ¹ì¸ ì‹¤íŒ¨:', result.error);
            showAlert('danger', result.error || 'ë“±ë¡ ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('âŒ ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
        showAlert('danger', `ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    } finally {
        hideLoading();
        console.log('ğŸ”„ ìŠ¹ì¸ ì²˜ë¦¬ ì™„ë£Œ');
    }
}

async function rejectRegistration(registrationId) {
    if (!confirm('ì´ ë“±ë¡ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    console.log('ğŸ”„ ê±°ë¶€ ì²˜ë¦¬ ì‹œì‘ - ë“±ë¡ ID:', registrationId);
    showLoading('ë“±ë¡ ê±°ë¶€ ì¤‘...');
    
    try {
        console.log('ğŸ“¡ ê±°ë¶€ API í˜¸ì¶œ ì‹œì‘');
        const response = await fetch(`/api/reject/${registrationId}`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('ğŸ“¡ ê±°ë¶€ API ì‘ë‹µ ìƒíƒœ:', response.status, response.ok);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('ğŸ“¡ ê±°ë¶€ API ì‘ë‹µ ë°ì´í„°:', result);
        
        if (result.success) {
            console.log('âœ… ê±°ë¶€ ì„±ê³µ:', result.message);
            showAlert('success', result.message || 'ë“±ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // ë„¤íŠ¸ì›Œí¬ í†µì‹  ì™„ë£Œ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
            console.log('ğŸ”„ ê±°ë¶€ ì™„ë£Œ - 2ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨');
            setTimeout(() => {
                console.log('ğŸ”„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰');
                location.reload();
            }, 2000);
        } else {
            console.error('âŒ ê±°ë¶€ ì‹¤íŒ¨:', result.error);
            showAlert('danger', result.error || 'ë“±ë¡ ê±°ë¶€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('âŒ ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
        showAlert('danger', `ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    } finally {
        hideLoading();
        console.log('ğŸ”„ ê±°ë¶€ ì²˜ë¦¬ ì™„ë£Œ');
    }
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function showLoading(message = 'ì²˜ë¦¬ ì¤‘...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-overlay';
    loadingDiv.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
    loadingDiv.style.cssText = 'background: rgba(0,0,0,0.5); z-index: 9999;';
    loadingDiv.innerHTML = `
        <div class="card">
            <div class="card-body text-center">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <div>${message}</div>
            </div>
        </div>
    `;
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading-overlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“„ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ë¡œë“œë¨');
    
    // í˜„ì¬ ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
    const systemInfoElement = document.getElementById('system-info');
    if (systemInfoElement) {
        console.log('ğŸ” í˜„ì¬ ì‹œìŠ¤í…œ ì •ë³´:', systemInfoElement.innerHTML);
    }
    
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    refreshSchedulerStatus();
    refreshNotificationStats();
    refreshNotificationLogs();
    
    // ì„œë²„ ë Œë”ë§ëœ ê°’ì´ ìˆëŠ”ì§€ í™•ì¸ í›„ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ìƒˆë¡œê³ ì¹¨
    setTimeout(() => {
        const systemInfoElement = document.getElementById('system-info');
        if (systemInfoElement) {
            const currentContent = systemInfoElement.innerHTML;
            console.log('ğŸ” í˜„ì¬ ì‹œìŠ¤í…œ ì •ë³´ ë‚´ìš©:', currentContent);
            
            // undefinedê°€ í¬í•¨ë˜ì–´ ìˆê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš°ì—ë§Œ ìƒˆë¡œê³ ì¹¨
            // ë˜í•œ "ë¡œë”©ì¤‘..." í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ìƒˆë¡œê³ ì¹¨
            if (currentContent.includes('undefined') || 
                currentContent.includes('ë¡œë”©ì¤‘...') || 
                currentContent.trim() === '' ||
                currentContent.includes('NaN') ||
                currentContent.includes('null')) {
                console.log('âš ï¸ undefined ë˜ëŠ” ë¡œë”© ìƒíƒœ ë°œê²¬, í†µê³„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ í•„ìš”');
                refreshStats();
            } else {
                console.log('âœ… ì„œë²„ ë Œë”ë§ëœ ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë¨, JavaScript ì—…ë°ì´íŠ¸ ìƒëµ');
                // ì„œë²„ ë Œë”ë§ëœ ê°’ì´ ì •ìƒì ì´ë¯€ë¡œ JavaScript ì—…ë°ì´íŠ¸ë¥¼ í•˜ì§€ ì•ŠìŒ
            }
        }
    }, 1000);
    
    // ì •ê¸°ì ìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸ (30ì´ˆë§ˆë‹¤)
    setInterval(() => {
        refreshSchedulerStatus();
        refreshNotificationStats();
        refreshNotificationLogs();
        refreshStats();
    }, 30000);
});

// í†µê³„ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
async function refreshStats() {
    try {
        console.log('ğŸ“Š í†µê³„ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
        
        // ë¡œë”© í‘œì‹œ (ê¸°ì¡´ ê°’ ìœ ì§€í•˜ë©´ì„œ ë¡œë”© í‘œì‹œë§Œ ì¶”ê°€)
        const loadingElements = document.querySelectorAll('.loading-indicator');
        loadingElements.forEach(el => el.style.display = 'inline-block');
        
        const response = await fetch('/api/stats');
        console.log('ğŸ“Š í†µê³„ ì‘ë‹µ:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
                    console.log('ğŸ“Š ë°›ì€ í†µê³„ ë°ì´í„°:', data.data ? data.data.stats : 'data.dataê°€ ì—†ìŒ');
            
            if (data.success && data.data && data.data.stats) {
                const stats = data.data.stats;
            
            // ë°ì´í„° ê²€ì¦
            const totalAccounts = stats.total_accounts || 0;
            const totalProperties = stats.total_properties || 0;
            const activeUsers = stats.active_users || 0;
            const expiringSoon = stats.expiring_soon || 0;
            
            console.log('ğŸ“Š ê²€ì¦ëœ ë°ì´í„° - ê³„ì •:', totalAccounts, 'í”„ë¡œí¼í‹°:', totalProperties, 'ì‚¬ìš©ì:', activeUsers);
            
            // ì•ˆì „í•˜ê²Œ DOM ì—…ë°ì´íŠ¸ (ìš”ì†Œê°€ ì¡´ì¬í•  ë•Œë§Œ)
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`âœ… ${id} ì—…ë°ì´íŠ¸:`, value);
                    return true;
                } else {
                    console.warn(`âš ï¸ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${id}`);
                    return false;
                }
            };
            
            // ìƒë‹¨ ì¹´ë“œë“¤ ì—…ë°ì´íŠ¸ (ìƒì„¸ ë””ë²„ê¹…)
            console.log('ğŸ” ìƒë‹¨ ì¹´ë“œ ì—…ë°ì´íŠ¸ ì‹œì‘...');
            
            // ë¨¼ì € DOMì—ì„œ ëª¨ë“  ìš”ì†Œ í™•ì¸
            console.log('ğŸ” DOM ì „ì²´ ìš”ì†Œ í™•ì¸:');
            console.log('- total-accounts-card:', document.getElementById('total-accounts-card'));
            console.log('- total-properties-card:', document.getElementById('total-properties-card'));
            console.log('- active-users-card:', document.getElementById('active-users-card'));
            console.log('- expiring-soon-card:', document.getElementById('expiring-soon-card'));
            
            // ëª¨ë“  card ê´€ë ¨ ìš”ì†Œ ì°¾ê¸°
            const allElements = document.querySelectorAll('*');
            const cardElements = Array.from(allElements).filter(el => el.id && el.id.includes('card'));
            console.log('ğŸ” DOMì—ì„œ ì°¾ì€ ëª¨ë“  card ìš”ì†Œë“¤:', cardElements.map(el => ({id: el.id, text: el.textContent.trim()})));
            
            // ê° ì¹´ë“œë³„ë¡œ ìƒì„¸ ë””ë²„ê¹…
            const cardUpdates = [
                { id: 'total-accounts-card', value: totalAccounts, name: 'ì´ ê³„ì •' },
                { id: 'total-properties-card', value: totalProperties, name: 'ì´ í”„ë¡œí¼í‹°' },
                { id: 'active-users-card', value: activeUsers, name: 'í™œì„± ì‚¬ìš©ì' },
                { id: 'expiring-soon-card', value: expiringSoon, name: 'ë§Œë£Œ ì˜ˆì •' }
            ];
            
            cardUpdates.forEach(card => {
                console.log(`ğŸ” ${card.name} ì¹´ë“œ ì—…ë°ì´íŠ¸ ì‹œë„ - ID: ${card.id}, ê°’: ${card.value}`);
                const element = document.getElementById(card.id);
                console.log(`ğŸ” ${card.name} DOM ìš”ì†Œ:`, element);
                
                if (element) {
                    const currentValue = element.textContent;
                    console.log(`ğŸ” ${card.name} í˜„ì¬ ê°’: "${currentValue}"`);
                    element.textContent = card.value;
                    console.log(`âœ… ${card.name} ì¹´ë“œ ì—…ë°ì´íŠ¸ ì„±ê³µ: ${currentValue} â†’ ${card.value}`);
                } else {
                    console.error(`âŒ ${card.name} ì¹´ë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - ID: ${card.id}`);
                }
            });
            
            // ì‹œìŠ¤í…œ ì •ë³´ ì„¹ì…˜ ì—…ë°ì´íŠ¸
            updateElement('total-accounts', totalAccounts);
            updateElement('total-properties', totalProperties);
            updateElement('active-users', activeUsers);
            updateElement('expiring-soon', expiringSoon);
            updateElement('total-notifications', stats.total_notifications || 0);
            updateElement('total-audit-logs', stats.total_audit_logs || 0);
            updateElement('total-registrations', stats.total_registrations || 0);
            
            console.log('âœ… ì‹œìŠ¤í…œ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        } else {
            console.error('âŒ ì˜ëª»ëœ ì‘ë‹µ ë°ì´í„°:', data);
        }
        
        // ë¡œë”© í‘œì‹œ ìˆ¨ê¸°ê¸°
        loadingElements.forEach(el => el.style.display = 'none');
        
        console.log('âœ… í†µê³„ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ - ëª¨ë“  ìš”ì†Œ ì—…ë°ì´íŠ¸ë¨');
        
    } catch (error) {
        console.error('âŒ í†µê³„ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
        
        // ë¡œë”© í‘œì‹œ ìˆ¨ê¸°ê¸°
        const loadingElements = document.querySelectorAll('.loading-indicator');
        loadingElements.forEach(el => el.style.display = 'none');
        
        // ì˜¤ë¥˜ ì‹œì—ëŠ” ê¸°ì¡´ ê°’ ìœ ì§€ (undefinedë¡œ ë³€ê²½í•˜ì§€ ì•ŠìŒ)
        console.log('ğŸ”„ ì˜¤ë¥˜ ë°œìƒìœ¼ë¡œ ê¸°ì¡´ ê°’ ìœ ì§€');
    }
}

// ë©”ì¼ ì „ì†¡ ì´ë ¥ ê´€ë¦¬ í•¨ìˆ˜ë“¤
async function refreshNotificationLogs() {
    try {
        console.log('ğŸ“§ ë©”ì¼ ì „ì†¡ ì´ë ¥ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
        
        const container = document.getElementById('notification-logs-container');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                </div>
            </div>
        `;
        
        const response = await fetch('/api/notification-logs');
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }
        
        const logs = data.data.logs;
        
        if (logs.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle"></i> ë©”ì¼ ì „ì†¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            `;
            return;
        }
        
        // í…Œì´ë¸” ìƒì„±
        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ìƒíƒœ</th>
                            <th>ì´ë©”ì¼</th>
                            <th>ì•Œë¦¼ íƒ€ì…</th>
                            <th>ì œëª©</th>
                            <th>ë°œì†¡ ì‹œê°„</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        logs.forEach(log => {
            const formattedDate = new Date(log.sent_at).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const typeMap = {
                'welcome': 'í™˜ì˜',
                'expiry_warning_30': 'ë§Œë£Œ 30ì¼ì „',
                'expiry_warning_7': 'ë§Œë£Œ 7ì¼ì „',
                'expiry_warning_1': 'ë§Œë£Œ 1ì¼ì „',
                'expired': 'ë§Œë£Œ ì•Œë¦¼',
                'admin': 'ê´€ë¦¬ì',
                'editor_downgrade': 'Editor ë‹¤ìš´ê·¸ë ˆì´ë“œ',
                'admin_downgrade': 'Admin ë‹¤ìš´ê·¸ë ˆì´ë“œ',
                'admin_approved': 'Admin ìŠ¹ì¸'
            };
            
            tableHtml += `
                <tr>
                    <td><span style="font-size: 1.2em;">${log.status_icon}</span></td>
                    <td><code>${log.user_email}</code></td>
                    <td><span class="badge bg-secondary">${typeMap[log.notification_type] || log.notification_type}</span></td>
                    <td>${log.subject || '-'}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearSpecificEmailLogs('${log.user_email}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tableHtml += `
                    </tbody>
                </table>
            </div>
            <div class="mt-3 text-muted">
                <small>ì´ ${logs.length}ê°œì˜ ë©”ì¼ ì „ì†¡ ì´ë ¥ (ìµœê·¼ 100ê°œ)</small>
            </div>
        `;
        
        container.innerHTML = tableHtml;
        console.log('âœ… ë©”ì¼ ì „ì†¡ ì´ë ¥ ë¡œë“œ ì™„ë£Œ');
        
    } catch (error) {
        console.error('âŒ ë©”ì¼ ì „ì†¡ ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('notification-logs-container').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> ë©”ì¼ ì „ì†¡ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}
            </div>
        `;
    }
}

async function clearAllNotificationLogs() {
    if (!confirm('âš ï¸ ëª¨ë“  ë©”ì¼ ì „ì†¡ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }
    
    try {
        showLoading('ì „ì²´ ë©”ì¼ ì´ë ¥ ì‚­ì œ ì¤‘...');
        
        const response = await fetch('/api/notification-logs', {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
        
        showAlert('success', data.message);
        await refreshNotificationLogs();
        
    } catch (error) {
        console.error('âŒ ì „ì²´ ë©”ì¼ ì´ë ¥ ì‚­ì œ ì‹¤íŒ¨:', error);
        showAlert('danger', `ì „ì²´ ë©”ì¼ ì´ë ¥ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function clearTodayNotificationLogs() {
    if (!confirm('âš ï¸ ì˜¤ëŠ˜ ë‚ ì§œì˜ ë©”ì¼ ì „ì†¡ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        showLoading('ì˜¤ëŠ˜ ë©”ì¼ ì´ë ¥ ì‚­ì œ ì¤‘...');
        
        const response = await fetch('/api/notification-logs/today', {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
        
        showAlert('success', data.message);
        await refreshNotificationLogs();
        
    } catch (error) {
        console.error('âŒ ì˜¤ëŠ˜ ë©”ì¼ ì´ë ¥ ì‚­ì œ ì‹¤íŒ¨:', error);
        showAlert('danger', `ì˜¤ëŠ˜ ë©”ì¼ ì´ë ¥ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function clearSpecificEmailLogs(email) {
    // í•¨ìˆ˜ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì€ ì´ë©”ì¼ì´ ì—†ìœ¼ë©´ ì…ë ¥ í•„ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸°
    if (!email) {
        email = document.getElementById('specificEmail').value.trim();
    }
    
    if (!email) {
        showAlert('warning', 'ì‚­ì œí•  ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!confirm(`âš ï¸ ${email}ì˜ ë©”ì¼ ì „ì†¡ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    try {
        showLoading(`${email} ë©”ì¼ ì´ë ¥ ì‚­ì œ ì¤‘...`);
        
        const response = await fetch(`/api/notification-logs/${encodeURIComponent(email)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
        
        showAlert('success', data.message);
        await refreshNotificationLogs();
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        const inputField = document.getElementById('specificEmail');
        if (inputField) {
            inputField.value = '';
        }
        
    } catch (error) {
        console.error('âŒ íŠ¹ì • ì´ë©”ì¼ ë©”ì¼ ì´ë ¥ ì‚­ì œ ì‹¤íŒ¨:', error);
        showAlert('danger', `íŠ¹ì • ì´ë©”ì¼ ë©”ì¼ ì´ë ¥ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// ë§Œë£Œ ì‚¬ìš©ì ì²˜ë¦¬ í•¨ìˆ˜
async function processExpiredUsers() {
    if (!confirm('âš ï¸ ë§Œë£Œëœ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ê³  ì•Œë¦¼ì„ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }
    
    try {
        showLoading('ë§Œë£Œ ì‚¬ìš©ì ì²˜ë¦¬ ì¤‘...');
        
        const response = await fetch('/api/process-expired-users', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'ë§Œë£Œ ì‚¬ìš©ì ì²˜ë¦¬ ì‹¤íŒ¨');
        }
        
        const results = data.data;
        const message = `ë§Œë£Œ ì‚¬ìš©ì ì²˜ë¦¬ ì™„ë£Œ\nì²˜ë¦¬: ${results.processed}ëª…\në°œì†¡: ${results.sent}ëª…\nì‹¤íŒ¨: ${results.failed}ëª…\nê±´ë„ˆëœ€: ${results.skipped}ëª…`;
        
        showAlert('success', message);
        
        // ë©”ì¼ ì „ì†¡ ì´ë ¥ê³¼ í†µê³„ ìƒˆë¡œê³ ë¦¼
        setTimeout(async () => {
            await refreshNotificationLogs();
            await refreshStats();
        }, 1000);
        
    } catch (error) {
        console.error('âŒ ë§Œë£Œ ì‚¬ìš©ì ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        showAlert('danger', `ë§Œë£Œ ì‚¬ìš©ì ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
function showTestNotificationModal() {
    const modal = new bootstrap.Modal(document.getElementById('testNotificationModal'));
    modal.show();
}

// Editor ìŠ¹ì¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
function showEditorApprovalModal() {
    const modal = new bootstrap.Modal(document.getElementById('editorApprovalModal'));
    modal.show();
}

async function executeEditorApproval() {
    const email = document.getElementById('editorApprovalEmail').value.trim();
    const type = document.getElementById('editorApprovalType').value;
    
    if (!email) {
        showAlert('warning', 'ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        showLoading('Editor ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘...');
        
        // ëª¨ë‹¬ ë‹«ê¸°
        const modal = bootstrap.Modal.getInstance(document.getElementById('editorApprovalModal'));
        if (modal) {
            modal.hide();
        }
        
        let endpoint = type === 'real' ? '/api/approve-editor' : '/api/test-editor-approval';
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: email
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Editor ìŠ¹ì¸ ì²˜ë¦¬ ì‹¤íŒ¨');
        }
        
        const message = type === 'real' 
            ? `Editor ê¶Œí•œ ìŠ¹ì¸ ì™„ë£Œ!\nì‚¬ìš©ì: ${email}\në§Œë£Œì¼: ${data.data.expiry_date}\nìŠ¹ì¸ ë©”ì¼: ${data.data.approval_notification_sent ? 'ë°œì†¡ë¨' : 'ì‹¤íŒ¨'}\ní™˜ì˜ ë©”ì¼: ${data.data.welcome_notification_sent ? 'ë°œì†¡ë¨' : 'ì‹¤íŒ¨'}`
            : `Editor ìŠ¹ì¸ í…ŒìŠ¤íŠ¸ ë©”ì¼ ë°œì†¡ ì™„ë£Œ!\nì‚¬ìš©ì: ${email}\në©”ì¼ ë°œì†¡: ${data.data.notification_sent ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`;
        
        showAlert('success', message);
        
        // ë©”ì¼ ì „ì†¡ ì´ë ¥ ìƒˆë¡œê³ ì¹¨
        setTimeout(async () => {
            await refreshNotificationLogs();
            if (type === 'real') {
                await refreshStats();
            }
        }, 1000);
        
    } catch (error) {
        console.error('âŒ Editor ìŠ¹ì¸ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        showAlert('danger', `Editor ìŠ¹ì¸ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function viewPendingEditorRequests() {
    try {
        const modal = new bootstrap.Modal(document.getElementById('pendingRequestsModal'));
        modal.show();
        
        await loadPendingRequests();
        
    } catch (error) {
        console.error('âŒ ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
        showAlert('danger', `ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
    }
}

async function loadPendingRequests() {
    try {
        const container = document.getElementById('pending-requests-container');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                </div>
            </div>
        `;
        
        const response = await fetch('/api/pending-editor-requests');
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const requests = data.data.requests;
        
        if (requests.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ Editor ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            `;
            return;
        }
        
        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ì‹ ì²­ì</th>
                            <th>ì‚¬ìš©ì ì´ë©”ì¼</th>
                            <th>í”„ë¡œí¼í‹°</th>
                            <th>ì‹ ì²­ì¼</th>
                            <th>ì‚¬ìœ </th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        requests.forEach(request => {
            const createdDate = new Date(request.created_at);
            const formattedDate = createdDate.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            tableHtml += `
                <tr>
                    <td>${request.applicant || '-'}</td>
                    <td><code>${request.user_email}</code></td>
                    <td>${request.property_name}</td>
                    <td>${formattedDate}</td>
                    <td>${request.reason || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-success me-1" onclick="approveEditorFromList('${request.user_email}', '${request.property_id}')">
                            ìŠ¹ì¸
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="rejectEditorFromList('${request.user_email}', '${request.property_id}')">
                            ê±°ë¶€
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tableHtml += `
                    </tbody>
                </table>
            </div>
            <div class="mt-3 text-muted">
                <small>ì´ ${requests.length}ê°œì˜ ìŠ¹ì¸ ëŒ€ê¸° ìš”ì²­</small>
            </div>
        `;
        
        container.innerHTML = tableHtml;
        
    } catch (error) {
        console.error('âŒ ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('pending-requests-container').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}
            </div>
        `;
    }
}

async function approveEditorFromList(userEmail, propertyId) {
    if (!confirm(`${userEmail}ì˜ Editor ê¶Œí•œì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    try {
        showLoading('Editor ê¶Œí•œ ìŠ¹ì¸ ì¤‘...');
        
        const response = await fetch('/api/approve-editor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: userEmail,
                property_id: propertyId
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Editor ê¶Œí•œ ìŠ¹ì¸ ì‹¤íŒ¨');
        }
        
        showAlert('success', `${userEmail}ì˜ Editor ê¶Œí•œì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadPendingRequests();
        await refreshNotificationLogs();
        
    } catch (error) {
        console.error('âŒ Editor ê¶Œí•œ ìŠ¹ì¸ ì‹¤íŒ¨:', error);
        showAlert('danger', `Editor ê¶Œí•œ ìŠ¹ì¸ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function rejectEditorFromList(userEmail, propertyId) {
    if (!confirm(`${userEmail}ì˜ Editor ê¶Œí•œ ìš”ì²­ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    // TODO: ê±°ë¶€ API êµ¬í˜„ í•„ìš”
    showAlert('info', 'Editor ê¶Œí•œ ê±°ë¶€ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
}

async function testEditorApprovalFlow() {
    if (!confirm('ì™„ì „í•œ Editor ìŠ¹ì¸ í”Œë¡œìš°ë¥¼ í…ŒìŠ¤íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní…ŒìŠ¤íŠ¸ ì‚¬ìš©ìë¡œ ì „ì²´ ê³¼ì •ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.')) {
        return;
    }
    
    try {
        showLoading('ì™„ì „í•œ ìŠ¹ì¸ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì¤‘...');
        
        const testEmail = 'complete_test@example.com';
        
        // 1ë‹¨ê³„: Editor ìŠ¹ì¸ í…ŒìŠ¤íŠ¸
        const approvalResponse = await fetch('/api/test-editor-approval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: testEmail
            })
        });
        
        const approvalData = await approvalResponse.json();
        
        if (!approvalResponse.ok || !approvalData.success) {
            throw new Error('ìŠ¹ì¸ ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨');
        }
        
        // 2ë‹¨ê³„: Welcome ë©”ì¼ ë°œì†¡
        const welcomeResponse = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: testEmail,
                notification_type: 'welcome'
            })
        });
        
        const welcomeData = await welcomeResponse.json();
        
        if (!welcomeResponse.ok || !welcomeData.success) {
            throw new Error('í™˜ì˜ ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨');
        }
        
        // 3ë‹¨ê³„: 7ì¼ ë§Œë£Œ ê²½ê³  ë©”ì¼ ë°œì†¡
        const warningResponse = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: testEmail,
                notification_type: 'expiry_warning_7'
            })
        });
        
        const warningData = await warningResponse.json();
        
        // 4ë‹¨ê³„: ì‚­ì œ ì•Œë¦¼ ë°œì†¡ (ì„ íƒì )
        const deletionResponse = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: testEmail,
                notification_type: 'deletion_notice'
            })
        });
        
        const deletionData = await deletionResponse.json();
        
        const message = `ì™„ì „í•œ Editor ìŠ¹ì¸ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì™„ë£Œ!\n\ní…ŒìŠ¤íŠ¸ ì´ë©”ì¼: ${testEmail}\n\nê²°ê³¼:\nâœ… Editor ìŠ¹ì¸ ë©”ì¼: ${approvalData.data.notification_sent ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}\nâœ… í™˜ì˜ ë©”ì¼: ${welcomeData.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}\nâœ… 7ì¼ ë§Œë£Œ ê²½ê³ : ${warningData.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}\nâœ… ì‚­ì œ ì•Œë¦¼: ${deletionData.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`;
        
        showAlert('success', message);
        
        // ë©”ì¼ ì „ì†¡ ì´ë ¥ ìƒˆë¡œê³ ì¹¨
        setTimeout(async () => {
            await refreshNotificationLogs();
        }, 1000);
        
    } catch (error) {
        console.error('âŒ ì™„ì „í•œ ìŠ¹ì¸ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        showAlert('danger', `ì™„ì „í•œ ìŠ¹ì¸ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// Admin ìŠ¹ì¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
function showAdminApprovalModal() {
    const modal = new bootstrap.Modal(document.getElementById('adminApprovalModal'));
    modal.show();
}

async function executeAdminApproval() {
    const email = document.getElementById('adminApprovalEmail').value.trim();
    const type = document.getElementById('adminApprovalType').value;
    
    if (!email) {
        showAlert('warning', 'ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!confirm(`${email}ì—ê²Œ Admin ê¶Œí•œì„ ${type === 'real' ? 'ì‹¤ì œë¡œ' : 'í…ŒìŠ¤íŠ¸'} ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nAdmin ê¶Œí•œì€ ìµœê³  ê¶Œí•œì…ë‹ˆë‹¤.`)) {
        return;
    }
    
    try {
        showLoading('Admin ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘...');
        
        // ëª¨ë‹¬ ë‹«ê¸°
        const modal = bootstrap.Modal.getInstance(document.getElementById('adminApprovalModal'));
        if (modal) {
            modal.hide();
        }
        
        let endpoint = type === 'real' ? '/api/approve-admin' : '/api/test-admin-approval';
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: email
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Admin ìŠ¹ì¸ ì²˜ë¦¬ ì‹¤íŒ¨');
        }
        
        const message = type === 'real' 
            ? `Admin ê¶Œí•œ ìŠ¹ì¸ ì™„ë£Œ!\nì‚¬ìš©ì: ${email}\në§Œë£Œì¼: ${data.data.expiry_date}\nìŠ¹ì¸ ë©”ì¼: ${data.data.approval_notification_sent ? 'ë°œì†¡ë¨' : 'ì‹¤íŒ¨'}\ní™˜ì˜ ë©”ì¼: ${data.data.welcome_notification_sent ? 'ë°œì†¡ë¨' : 'ì‹¤íŒ¨'}`
            : `Admin ìŠ¹ì¸ í…ŒìŠ¤íŠ¸ ë©”ì¼ ë°œì†¡ ì™„ë£Œ!\nì‚¬ìš©ì: ${email}\në©”ì¼ ë°œì†¡: ${data.data.notification_sent ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`;
        
        showAlert('success', message);
        
        // ë©”ì¼ ì „ì†¡ ì´ë ¥ ìƒˆë¡œê³ ì¹¨
        setTimeout(async () => {
            await refreshNotificationLogs();
            if (type === 'real') {
                await refreshStats();
            }
        }, 1000);
        
    } catch (error) {
        console.error('âŒ Admin ìŠ¹ì¸ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        showAlert('danger', `Admin ìŠ¹ì¸ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function viewPendingAdminRequests() {
    try {
        const modal = new bootstrap.Modal(document.getElementById('pendingAdminRequestsModal'));
        modal.show();
        
        await loadPendingAdminRequests();
        
    } catch (error) {
        console.error('âŒ Admin ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
        showAlert('danger', `Admin ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
    }
}

async function loadPendingAdminRequests() {
    try {
        const container = document.getElementById('pending-admin-requests-container');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                </div>
            </div>
        `;
        
        const response = await fetch('/api/pending-admin-requests');
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Admin ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const requests = data.data.requests;
        
        if (requests.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ Admin ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            `;
            return;
        }
        
        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="table-danger">
                        <tr>
                            <th>ì‹ ì²­ì</th>
                            <th>ì‚¬ìš©ì ì´ë©”ì¼</th>
                            <th>í”„ë¡œí¼í‹°</th>
                            <th>ì‹ ì²­ì¼</th>
                            <th>ì‚¬ìœ </th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        requests.forEach(request => {
            const createdDate = new Date(request.created_at);
            const formattedDate = createdDate.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            tableHtml += `
                <tr>
                    <td>${request.applicant || '-'}</td>
                    <td><code>${request.user_email}</code></td>
                    <td>${request.property_name}</td>
                    <td>${formattedDate}</td>
                    <td><span class="badge bg-danger">${request.reason || 'Admin ê¶Œí•œ ì‹ ì²­'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger me-1" onclick="approveAdminFromList('${request.user_email}', '${request.property_id}')">
                            ìŠ¹ì¸
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="rejectAdminFromList('${request.user_email}', '${request.property_id}')">
                            ê±°ë¶€
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tableHtml += `
                    </tbody>
                </table>
            </div>
            <div class="mt-3 text-muted">
                <small>ì´ ${requests.length}ê°œì˜ Admin ìŠ¹ì¸ ëŒ€ê¸° ìš”ì²­ (ìµœê³  ê¶Œí•œ)</small>
            </div>
        `;
        
        container.innerHTML = tableHtml;
        
    } catch (error) {
        console.error('âŒ Admin ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('pending-admin-requests-container').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Admin ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}
            </div>
        `;
    }
}

async function approveAdminFromList(userEmail, propertyId) {
    if (!confirm(`${userEmail}ì—ê²Œ Admin ê¶Œí•œì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜: Admin ê¶Œí•œì€ ìµœê³  ê¶Œí•œìœ¼ë¡œ ëª¨ë“  ì‘ì—…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`)) {
        return;
    }
    
    try {
        showLoading('Admin ê¶Œí•œ ìŠ¹ì¸ ì¤‘...');
        
        const response = await fetch('/api/approve-admin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: userEmail,
                property_id: propertyId
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Admin ê¶Œí•œ ìŠ¹ì¸ ì‹¤íŒ¨');
        }
        
        showAlert('success', `${userEmail}ì˜ Admin ê¶Œí•œì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadPendingAdminRequests();
        await refreshNotificationLogs();
        
    } catch (error) {
        console.error('âŒ Admin ê¶Œí•œ ìŠ¹ì¸ ì‹¤íŒ¨:', error);
        showAlert('danger', `Admin ê¶Œí•œ ìŠ¹ì¸ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function rejectAdminFromList(userEmail, propertyId) {
    if (!confirm(`${userEmail}ì˜ Admin ê¶Œí•œ ìš”ì²­ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    // TODO: ê±°ë¶€ API êµ¬í˜„ í•„ìš”
    showAlert('info', 'Admin ê¶Œí•œ ê±°ë¶€ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
}

async function testAdminApprovalFlow() {
    if (!confirm('ì™„ì „í•œ Admin ìŠ¹ì¸ í”Œë¡œìš°ë¥¼ í…ŒìŠ¤íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nâš ï¸ Admin ê¶Œí•œì€ ìµœê³  ê¶Œí•œì…ë‹ˆë‹¤.')) {
        return;
    }
    
    try {
        showLoading('ì™„ì „í•œ Admin ìŠ¹ì¸ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì¤‘...');
        
        const testEmail = 'admin_test@example.com';
        
        // 1ë‹¨ê³„: Admin ìŠ¹ì¸ í…ŒìŠ¤íŠ¸
        const approvalResponse = await fetch('/api/test-admin-approval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: testEmail
            })
        });
        
        const approvalData = await approvalResponse.json();
        
        if (!approvalResponse.ok || !approvalData.success) {
            throw new Error('Admin ìŠ¹ì¸ ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨');
        }
        
        // 2ë‹¨ê³„: Welcome ë©”ì¼ ë°œì†¡
        const welcomeResponse = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: testEmail,
                notification_type: 'welcome'
            })
        });
        
        const welcomeData = await welcomeResponse.json();
        
        // 3ë‹¨ê³„: Admin ì•Œë¦¼ ë°œì†¡ (ì¤‘ìš” ì•Œë¦¼)
        const adminNotificationResponse = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: testEmail,
                notification_type: 'admin'
            })
        });
        
        const adminNotificationData = await adminNotificationResponse.json();
        
        const message = `ì™„ì „í•œ Admin ìŠ¹ì¸ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì™„ë£Œ!\n\ní…ŒìŠ¤íŠ¸ ì´ë©”ì¼: ${testEmail}\n\nê²°ê³¼:\nâœ… Admin ìŠ¹ì¸ ë©”ì¼: ${approvalData.data.notification_sent ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}\nâœ… í™˜ì˜ ë©”ì¼: ${welcomeData.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}\nâœ… Admin ì¤‘ìš” ì•Œë¦¼: ${adminNotificationData.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}\n\nâš ï¸ Admin ê¶Œí•œì€ 7ì¼ í›„ ìë™ìœ¼ë¡œ Viewerë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œë©ë‹ˆë‹¤.`;
        
        showAlert('success', message);
        
        // ë©”ì¼ ì „ì†¡ ì´ë ¥ ìƒˆë¡œê³ ì¹¨
        setTimeout(async () => {
            await refreshNotificationLogs();
        }, 1000);
        
    } catch (error) {
        console.error('âŒ ì™„ì „í•œ Admin ìŠ¹ì¸ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        showAlert('danger', `ì™„ì „í•œ Admin ìŠ¹ì¸ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        hideLoading();
    }
}

</script>
{% endblock %} 