{% extends "base.html" %}

{% block title %}GA4 권한 관리 대시보드{% endblock %}

{% block content %}
<div class="container-fluid dashboard">
    <!-- 시스템 상태 카드 -->
    <div class="row mb-4">
        <div class="col-12 mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">📊 시스템 상태</h4>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-sm" onclick="showStats('dashboard')">
                        <i class="bi bi-arrow-clockwise"></i> 디버깅 새로고침
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshStats()">
                        <i class="bi bi-arrow-clockwise"></i> 일반 새로고침
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">총 계정</h5>
                    <h2 class="card-text" id="total-accounts-card">{{ stats.total_accounts if stats and stats.total_accounts is defined else 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">총 프로퍼티</h5>
                    <h2 class="card-text" id="total-properties-card">{{ stats.total_properties if stats and stats.total_properties is defined else 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">활성 사용자</h5>
                    <h2 class="card-text" id="active-users-card">{{ stats.active_users if stats and stats.active_users is defined else 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">만료 예정</h5>
                    <h2 class="card-text" id="expiring-soon-card">{{ stats.expiring_soon if stats and stats.expiring_soon is defined else 0 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- 스케줄러 상태 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">🤖 자동화 스케줄러 상태</h5>
                    <div id="scheduler-status-badge" class="badge bg-secondary">확인 중...</div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>상태:</strong> <span id="scheduler-running-status">확인 중...</span></p>
                            <p><strong>마지막 실행:</strong> <span id="scheduler-last-run">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group" role="group">
                                <button class="btn btn-success btn-sm" onclick="startScheduler()">시작</button>
                                <button class="btn btn-danger btn-sm" onclick="stopScheduler()">중지</button>
                                <button class="btn btn-info btn-sm" onclick="refreshSchedulerStatus()">새로고침</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 관리 도구 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">🛠️ 관리 도구</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- 기존 관리 도구들 -->
                        <div class="col-md-6 mb-3">
                            <h6>📊 데이터 관리</h6>
                            <div class="btn-group-vertical d-grid gap-2">
                                <button class="btn btn-primary" onclick="scanProperties()">프로퍼티 스캔</button>
                                <button class="btn btn-success" onclick="processQueue()">등록 대기열 처리</button>
                                <button class="btn btn-warning" onclick="processExpiration()">만료 처리</button>
                            </div>
                        </div>
                        
                        <!-- 새로운 알림 관리 도구들 -->
                        <div class="col-md-4 mb-3">
                            <h6>📧 알림 관리</h6>
                            <div class="btn-group-vertical d-grid gap-2">
                                <button class="btn btn-info" onclick="processExpiryNotifications()">만료 알림 발송</button>
                                <button class="btn btn-secondary" onclick="processEditorDowngrade()">Editor 권한 다운그레이드</button>
                                <button class="btn btn-danger" onclick="processAdminDowngrade()">Admin 권한 다운그레이드</button>
                                <button class="btn btn-outline-primary" onclick="showTestNotificationModal()">테스트 알림 발송</button>
                                <button class="btn btn-outline-danger" onclick="processExpiredUsers()">🗑️ 만료 사용자 삭제</button>
                            </div>
                        </div>
                        
                        <!-- Editor 승인 관리 -->
                        <div class="col-md-4 mb-3">
                            <h6>🔐 Editor 권한 관리</h6>
                            <div class="btn-group-vertical d-grid gap-2">
                                <button class="btn btn-success" onclick="showEditorApprovalModal()">✅ Editor 승인 테스트</button>
                                <button class="btn btn-warning" onclick="viewPendingEditorRequests()">⏳ 승인 대기 목록</button>
                                <button class="btn btn-info" onclick="testEditorApprovalFlow()">🧪 완전한 승인 플로우</button>
                            </div>
                        </div>
                        
                        <!-- Admin 승인 관리 -->
                        <div class="col-md-4 mb-3">
                            <h6>🔐 Admin 권한 관리</h6>
                            <div class="btn-group-vertical d-grid gap-2">
                                <button class="btn btn-danger" onclick="showAdminApprovalModal()">✅ Admin 승인 테스트</button>
                                <button class="btn btn-warning" onclick="viewPendingAdminRequests()">⏳ 승인 대기 목록</button>
                                <button class="btn btn-outline-danger" onclick="testAdminApprovalFlow()">🧪 완전한 승인 플로우</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 알림 통계 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">📈 알림 통계</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshNotificationStats()">새로고침</button>
                </div>
                <div class="card-body">
                    <div class="row" id="notification-stats">
                        <div class="col-12 text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">로딩 중...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 시스템 정보 섹션 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">📊 시스템 정보</h5>
                    <div id="system-info">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>계정:</strong> {{ stats.total_accounts if stats and stats.total_accounts is defined else 0 }}개<br>
                                <strong>프로퍼티:</strong> {{ stats.total_properties if stats and stats.total_properties is defined else 0 }}개<br>
                                <strong>활성 사용자:</strong> {{ stats.active_users if stats and stats.active_users is defined else 0 }}명
                            </div>
                            <div class="col-md-6">
                                <strong>만료 예정:</strong> {{ stats.expiring_soon if stats and stats.expiring_soon is defined else 0 }}명<br>
                                <strong>총 알림:</strong> {{ stats.total_notifications if stats and stats.total_notifications is defined else 0 }}개<br>
                                <strong>등록:</strong> {{ stats.total_registrations if stats and stats.total_registrations is defined else 0 }}개
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 기존 테이블들 -->
    <!-- GA4 계정 목록 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">🏢 GA4 계정 목록</h5>
                </div>
                <div class="card-body">
                    {% if accounts %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>계정명</th>
                                    <th>계정 ID</th>
                                    <th>표시명</th>
                                    <th>마지막 업데이트</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for account in accounts %}
                                <tr>
                                    <td>{{ account.account_name }}</td>
                                    <td><code>{{ account.account_id }}</code></td>
                                    <td>{{ account.display_name }}</td>
                                    <td>{{ account.last_updated[:19] if account.last_updated else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">등록된 GA4 계정이 없습니다.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- GA4 프로퍼티 목록 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">🏠 GA4 프로퍼티 목록</h5>
                </div>
                <div class="card-body">
                    {% if properties %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>프로퍼티명</th>
                                    <th>프로퍼티 ID</th>
                                    <th>계정</th>
                                    <th>타임존</th>
                                    <th>마지막 업데이트</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for property in properties %}
                                <tr>
                                    <td>{{ property.property_name }}</td>
                                    <td><code>{{ property.property_id }}</code></td>
                                    <td>{{ property.account_name }}</td>
                                    <td>{{ property.time_zone }}</td>
                                    <td>{{ property.last_updated[:19] if property.last_updated else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">등록된 GA4 프로퍼티가 없습니다.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 메일 전송 이력 관리 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">📧 메일 전송 이력</h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshNotificationLogs()">
                            <i class="bi bi-arrow-clockwise"></i> 새로고침
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="clearTodayNotificationLogs()">
                            <i class="bi bi-calendar-x"></i> 오늘 이력 삭제
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearAllNotificationLogs()">
                            <i class="bi bi-trash"></i> 전체 초기화
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="email" class="form-control" id="specificEmail" placeholder="특정 이메일 주소를 입력하세요">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-info w-100" onclick="clearSpecificEmailLogs()">
                                <i class="bi bi-person-x"></i> 이 이메일 이력 삭제
                            </button>
                        </div>
                    </div>
                    
                    <div id="notification-logs-container">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">로딩 중...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 사용자 등록 현황 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">👥 사용자 등록 현황</h5>
                    <a href="/register" class="btn btn-primary btn-sm">새 사용자 등록</a>
                </div>
                <div class="card-body">
                    {% if registrations %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>사용자</th>
                                    <th>이메일</th>
                                    <th>프로퍼티</th>
                                    <th>권한</th>
                                    <th>상태</th>
                                    <th>등록일</th>
                                    <th>만료일</th>
                                    <th>GA4 등록</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reg in registrations %}
                                <tr>
                                    <td>{{ reg.applicant }}</td>
                                    <td>{{ reg.user_email }}</td>
                                    <td>{{ reg.property_name }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'warning' if reg.permission_level == 'editor' else 'info' }}">
                                            {{ reg.permission_level }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if reg.status == 'active' else 'warning' if reg.status == 'pending_approval' else 'secondary' }}">
                                            {{ reg.status }}
                                        </span>
                                    </td>
                                    <td>{{ reg.created_at[:19] if reg.created_at else '-' }}</td>
                                    <td>{{ reg.expiry_date[:19] if reg.expiry_date else '-' }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if reg.ga4_registered else 'danger' }}">
                                            {{ '등록됨' if reg.ga4_registered else '미등록' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if reg.status == 'pending_approval' %}
                                        <button class="btn btn-sm btn-success me-1" onclick="approveRegistration('{{ reg.id }}')">승인</button>
                                        <button class="btn btn-sm btn-danger" onclick="rejectRegistration('{{ reg.id }}')">거부</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">등록된 사용자가 없습니다.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 테스트 알림 모달 -->
<div class="modal fade" id="testNotificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">테스트 알림 발송</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testNotificationForm">
                    <div class="mb-3">
                        <label for="testEmail" class="form-label">이메일 주소</label>
                        <input type="email" class="form-control" id="testEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="testNotificationType" class="form-label">알림 타입</label>
                        <select class="form-select" id="testNotificationType">
                            <option value="welcome">환영 이메일</option>
                            <option value="expiry_warning_30">30일 만료 알림</option>
                            <option value="expiry_warning_7">7일 만료 알림</option>
                            <option value="expiry_warning_1">1일 만료 알림</option>
                            <option value="expiry_today">당일 만료 알림</option>
                            <option value="deletion_notice">삭제 알림</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="sendTestNotification()">발송</button>
            </div>
        </div>
    </div>
</div>

<!-- Editor 승인 테스트 모달 -->
<div class="modal fade" id="editorApprovalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editor 권한 승인 테스트</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editorApprovalForm">
                    <div class="mb-3">
                        <label for="editorApprovalEmail" class="form-label">이메일 주소</label>
                        <input type="email" class="form-control" id="editorApprovalEmail" placeholder="editor@example.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="editorApprovalType" class="form-label">테스트 타입</label>
                        <select class="form-select" id="editorApprovalType">
                            <option value="test">테스트 모드 (메일만 발송)</option>
                            <option value="real">실제 승인 (DB 업데이트 + 메일 발송)</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <strong>테스트 모드:</strong> 실제 DB 변경 없이 승인 메일만 발송<br>
                        <strong>실제 승인:</strong> DB에서 권한을 active/editor로 변경하고 메일 발송
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-success" onclick="executeEditorApproval()">승인 실행</button>
            </div>
        </div>
    </div>
</div>

<!-- Admin 승인 테스트 모달 -->
<div class="modal fade" id="adminApprovalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Admin 권한 승인 테스트</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>주의:</strong> Admin 권한은 최고 권한입니다. 신중하게 승인하세요.
                </div>
                <form id="adminApprovalForm">
                    <div class="mb-3">
                        <label for="adminApprovalEmail" class="form-label">이메일 주소</label>
                        <input type="email" class="form-control" id="adminApprovalEmail" placeholder="admin@example.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="adminApprovalType" class="form-label">테스트 타입</label>
                        <select class="form-select" id="adminApprovalType">
                            <option value="test">테스트 모드 (메일만 발송)</option>
                            <option value="real">실제 승인 (DB 업데이트 + 메일 발송)</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <strong>테스트 모드:</strong> 실제 DB 변경 없이 승인 메일만 발송<br>
                        <strong>실제 승인:</strong> DB에서 권한을 active/admin으로 변경하고 메일 발송 (7일 유지)
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-danger" onclick="executeAdminApproval()">승인 실행</button>
            </div>
        </div>
    </div>
</div>

<!-- 승인 대기 목록 모달 -->
<div class="modal fade" id="pendingRequestsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">승인 대기 중인 Editor 요청</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="pending-requests-container">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">로딩 중...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-outline-primary" onclick="loadPendingRequests()">새로고침</button>
            </div>
        </div>
    </div>
</div>

<!-- Admin 승인 대기 목록 모달 -->
<div class="modal fade" id="pendingAdminRequestsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">승인 대기 중인 Admin 요청</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="pending-admin-requests-container">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">로딩 중...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-outline-primary" onclick="loadPendingAdminRequests()">새로고침</button>
            </div>
        </div>
    </div>
</div>

<script>
// 기존 JavaScript 함수들...
async function scanProperties() {
    showLoading('프로퍼티 스캔 중...');
    try {
        const response = await fetch('/api/scan', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            const scanResult = result.result;
            showAlert('success', `스캔 완료 - 계정: ${scanResult.accounts_found}개, 프로퍼티: ${scanResult.properties_found}개`);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', result.error || '프로퍼티 스캔에 실패했습니다.');
        }
    } catch (error) {
        showAlert('danger', '요청 처리 중 오류가 발생했습니다.');
    } finally {
        hideLoading();
    }
}

async function processQueue() {
    showLoading('등록 대기열 처리 중...');
    try {
        const response = await fetch('/api/process-queue', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', result.error || '대기열 처리에 실패했습니다.');
        }
    } catch (error) {
        showAlert('danger', '요청 처리 중 오류가 발생했습니다.');
    } finally {
        hideLoading();
    }
}

async function processExpiration() {
    if (!confirm('만료 처리를 실행하시겠습니까?')) return;
    
    showLoading('만료 처리 중...');
    try {
        const response = await fetch('/api/process-expiry-notifications', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', result.error || '만료 처리에 실패했습니다.');
        }
    } catch (error) {
        showAlert('danger', '요청 처리 중 오류가 발생했습니다.');
    } finally {
        hideLoading();
    }
}

// 새로운 JavaScript 함수들...
async function processExpiryNotifications() {
    showLoading('만료 알림 발송 중...');
    try {
        const response = await fetch('/api/process-expiry-notifications', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            refreshNotificationStats();
        } else {
            showAlert('danger', result.error || '만료 알림 발송에 실패했습니다.');
        }
    } catch (error) {
        showAlert('danger', '요청 처리 중 오류가 발생했습니다.');
    } finally {
        hideLoading();
    }
}

async function processEditorDowngrade() {
    if (!confirm('Editor 권한 다운그레이드를 실행하시겠습니까?')) return;
    
    showLoading('Editor 다운그레이드 처리 중...');
    try {
        const response = await fetch('/api/process-editor-downgrade', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', result.error || 'Editor 다운그레이드에 실패했습니다.');
        }
    } catch (error) {
        showAlert('danger', '요청 처리 중 오류가 발생했습니다.');
    } finally {
        hideLoading();
    }
}

async function processAdminDowngrade() {
    if (!confirm('Admin 권한 다운그레이드를 실행하시겠습니까?\n이 작업은 모든 Admin 사용자를 Viewer로 변경합니다.')) return;
    
    showLoading('Admin 다운그레이드 처리 중...');
    try {
        const response = await fetch('/api/process-admin-downgrade', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', result.error || 'Admin 다운그레이드에 실패했습니다.');
        }
    } catch (error) {
        showAlert('danger', '요청 처리 중 오류가 발생했습니다.');
    } finally {
        hideLoading();
    }
}

function showTestNotificationModal() {
    const modal = new bootstrap.Modal(document.getElementById('testNotificationModal'));
    modal.show();
}

async function sendTestNotification() {
    const email = document.getElementById('testEmail').value.trim();
    const type = document.getElementById('testNotificationType').value;
    
    if (!email) {
        showAlert('warning', '이메일 주소를 입력해주세요.');
        return;
    }
    
    try {
        showLoading('테스트 알림 발송 중...');
        
        // 모달 닫기
        const modal = bootstrap.Modal.getInstance(document.getElementById('testNotificationModal'));
        if (modal) {
            modal.hide();
        }
        
        const response = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: email,
                notification_type: type
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || '테스트 알림 발송 실패');
        }
        
        showAlert('success', data.message);
        
        // 메일 전송 이력 새로고침
        setTimeout(async () => {
            await refreshNotificationLogs();
        }, 1000);
        
    } catch (error) {
        console.error('❌ 테스트 알림 발송 실패:', error);
        showAlert('danger', `테스트 알림 발송 실패: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function refreshNotificationStats() {
    try {
        const response = await fetch('/api/notification-stats');
        const result = await response.json();
        
        if (result.success && result.data) {
            const stats = result.data;
            const statsHtml = `
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-primary">${stats.total_sent || 0}</h4>
                        <small class="text-muted">총 발송</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-success">${stats.today_sent || 0}</h4>
                        <small class="text-muted">오늘 발송</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-warning">${stats.pending_notifications || 0}</h4>
                        <small class="text-muted">대기 중</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-info">${stats.last_sent || '없음'}</h4>
                        <small class="text-muted">마지막 발송</small>
                    </div>
                </div>
            `;
            const notificationStatsElement = document.getElementById('notification-stats');
            if (notificationStatsElement) {
                notificationStatsElement.innerHTML = statsHtml;
            }
            console.log('✅ 알림 통계 업데이트 완료:', stats);
        } else {
            console.error('❌ 알림 통계 조회 실패:', result);
            // 실패 시 기본값 표시
            const notificationStatsElement = document.getElementById('notification-stats');
            if (notificationStatsElement) {
                notificationStatsElement.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">알림 통계를 불러올 수 없습니다.</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('❌ 알림 통계 조회 오류:', error);
        // 오류 발생 시 기본값 표시
        const notificationStatsElement = document.getElementById('notification-stats');
        if (notificationStatsElement) {
            notificationStatsElement.innerHTML = `
                <div class="col-12 text-center">
                    <p class="text-danger">알림 통계 조회 중 오류가 발생했습니다.</p>
                </div>
            `;
        }
    }
}

async function refreshSchedulerStatus() {
    try {
        const response = await fetch('/api/scheduler-status');
        const result = await response.json();
        
        if (result.success && result.data) {
            const status = result.data;
            const isRunning = status.is_running;
            
            // 스케줄러 상태 배지 업데이트
            const statusBadge = document.getElementById('scheduler-status-badge');
            if (statusBadge) {
                statusBadge.className = `badge ${isRunning ? 'bg-success' : 'bg-danger'}`;
                statusBadge.textContent = isRunning ? '실행 중' : '중지됨';
            }
            
            // 스케줄러 실행 상태 텍스트 업데이트
            const runningStatus = document.getElementById('scheduler-running-status');
            if (runningStatus) {
                runningStatus.textContent = isRunning ? '실행 중' : '중지됨';
            }
            
            // 마지막 실행 시간 업데이트
            const lastRun = document.getElementById('scheduler-last-run');
            if (lastRun) {
                lastRun.textContent = status.last_run || '없음';
            }
            
            console.log('✅ 스케줄러 상태 업데이트 완료:', status);
        } else {
            console.error('❌ 스케줄러 상태 조회 실패:', result);
        }
    } catch (error) {
        console.error('❌ 스케줄러 상태 조회 오류:', error);
        // 오류 발생 시 기본값 설정
        const statusBadge = document.getElementById('scheduler-status-badge');
        if (statusBadge) {
            statusBadge.className = 'badge bg-secondary';
            statusBadge.textContent = '오류';
        }
    }
}

async function startScheduler() {
    showLoading('스케줄러 시작 중...');
    try {
        const response = await fetch('/api/scheduler/start', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            refreshSchedulerStatus();
        } else {
            showAlert('danger', result.error || '스케줄러 시작에 실패했습니다.');
        }
    } catch (error) {
        showAlert('danger', '요청 처리 중 오류가 발생했습니다.');
    } finally {
        hideLoading();
    }
}

async function stopScheduler() {
    showLoading('스케줄러 중지 중...');
    try {
        const response = await fetch('/api/scheduler/stop', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            refreshSchedulerStatus();
        } else {
            showAlert('danger', result.error || '스케줄러 중지에 실패했습니다.');
        }
    } catch (error) {
        showAlert('danger', '요청 처리 중 오류가 발생했습니다.');
    } finally {
        hideLoading();
    }
}

async function approveRegistration(registrationId) {
    if (!confirm('이 등록을 승인하시겠습니까?')) return;
    
    console.log('🔄 승인 처리 시작 - 등록 ID:', registrationId);
    showLoading('등록 승인 중...');
    
    try {
        console.log('📡 승인 API 호출 시작');
        const response = await fetch(`/api/approve/${registrationId}`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('📡 승인 API 응답 상태:', response.status, response.ok);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('📡 승인 API 응답 데이터:', result);
        
        if (result.success) {
            console.log('✅ 승인 성공:', result.message);
            showAlert('success', result.message || '등록이 성공적으로 승인되었습니다.');
            
            // 네트워크 통신 완료 후 상태 업데이트
            console.log('🔄 승인 완료 - 2초 후 페이지 새로고침');
            setTimeout(() => {
                console.log('🔄 페이지 새로고침 실행');
                location.reload();
            }, 2000);
        } else {
            console.error('❌ 승인 실패:', result.error);
            showAlert('danger', result.error || '등록 승인에 실패했습니다.');
        }
    } catch (error) {
        console.error('❌ 승인 처리 중 오류:', error);
        showAlert('danger', `요청 처리 중 오류가 발생했습니다: ${error.message}`);
    } finally {
        hideLoading();
        console.log('🔄 승인 처리 완료');
    }
}

async function rejectRegistration(registrationId) {
    if (!confirm('이 등록을 거부하시겠습니까?')) return;
    
    console.log('🔄 거부 처리 시작 - 등록 ID:', registrationId);
    showLoading('등록 거부 중...');
    
    try {
        console.log('📡 거부 API 호출 시작');
        const response = await fetch(`/api/reject/${registrationId}`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('📡 거부 API 응답 상태:', response.status, response.ok);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('📡 거부 API 응답 데이터:', result);
        
        if (result.success) {
            console.log('✅ 거부 성공:', result.message);
            showAlert('success', result.message || '등록이 성공적으로 거부되었습니다.');
            
            // 네트워크 통신 완료 후 상태 업데이트
            console.log('🔄 거부 완료 - 2초 후 페이지 새로고침');
            setTimeout(() => {
                console.log('🔄 페이지 새로고침 실행');
                location.reload();
            }, 2000);
        } else {
            console.error('❌ 거부 실패:', result.error);
            showAlert('danger', result.error || '등록 거부에 실패했습니다.');
        }
    } catch (error) {
        console.error('❌ 거부 처리 중 오류:', error);
        showAlert('danger', `요청 처리 중 오류가 발생했습니다: ${error.message}`);
    } finally {
        hideLoading();
        console.log('🔄 거부 처리 완료');
    }
}

// 유틸리티 함수들
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function showLoading(message = '처리 중...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-overlay';
    loadingDiv.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
    loadingDiv.style.cssText = 'background: rgba(0,0,0,0.5); z-index: 9999;';
    loadingDiv.innerHTML = `
        <div class="card">
            <div class="card-body text-center">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <div>${message}</div>
            </div>
        </div>
    `;
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading-overlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 대시보드 페이지 로드됨');
    
    // 현재 시스템 정보 확인
    const systemInfoElement = document.getElementById('system-info');
    if (systemInfoElement) {
        console.log('🔍 현재 시스템 정보:', systemInfoElement.innerHTML);
    }
    
    // 초기 데이터 로드
    refreshSchedulerStatus();
    refreshNotificationStats();
    refreshNotificationLogs();
    
    // 서버 렌더링된 값이 있는지 확인 후 필요한 경우에만 새로고침
    setTimeout(() => {
        const systemInfoElement = document.getElementById('system-info');
        if (systemInfoElement) {
            const currentContent = systemInfoElement.innerHTML;
            console.log('🔍 현재 시스템 정보 내용:', currentContent);
            
            // undefined가 포함되어 있거나 비어있는 경우에만 새로고침
            // 또한 "로딩중..." 텍스트가 있는 경우에만 새로고침
            if (currentContent.includes('undefined') || 
                currentContent.includes('로딩중...') || 
                currentContent.trim() === '' ||
                currentContent.includes('NaN') ||
                currentContent.includes('null')) {
                console.log('⚠️ undefined 또는 로딩 상태 발견, 통계 데이터 새로고침 필요');
                refreshStats();
            } else {
                console.log('✅ 서버 렌더링된 데이터가 정상적으로 표시됨, JavaScript 업데이트 생략');
                // 서버 렌더링된 값이 정상적이므로 JavaScript 업데이트를 하지 않음
            }
        }
    }, 1000);
    
    // 정기적으로 상태 업데이트 (30초마다)
    setInterval(() => {
        refreshSchedulerStatus();
        refreshNotificationStats();
        refreshNotificationLogs();
        refreshStats();
    }, 30000);
});

// 통계 새로고침 함수 (개선된 버전)
async function refreshStats() {
    try {
        console.log('📊 통계 새로고침 시작...');
        
        // 로딩 표시 (기존 값 유지하면서 로딩 표시만 추가)
        const loadingElements = document.querySelectorAll('.loading-indicator');
        loadingElements.forEach(el => el.style.display = 'inline-block');
        
        const response = await fetch('/api/stats');
        console.log('📊 통계 응답:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
                    console.log('📊 받은 통계 데이터:', data.data ? data.data.stats : 'data.data가 없음');
            
            if (data.success && data.data && data.data.stats) {
                const stats = data.data.stats;
            
            // 데이터 검증
            const totalAccounts = stats.total_accounts || 0;
            const totalProperties = stats.total_properties || 0;
            const activeUsers = stats.active_users || 0;
            const expiringSoon = stats.expiring_soon || 0;
            
            console.log('📊 검증된 데이터 - 계정:', totalAccounts, '프로퍼티:', totalProperties, '사용자:', activeUsers);
            
            // 안전하게 DOM 업데이트 (요소가 존재할 때만)
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`✅ ${id} 업데이트:`, value);
                    return true;
                } else {
                    console.warn(`⚠️ 요소를 찾을 수 없음: ${id}`);
                    return false;
                }
            };
            
            // 상단 카드들 업데이트 (상세 디버깅)
            console.log('🔍 상단 카드 업데이트 시작...');
            
            // 먼저 DOM에서 모든 요소 확인
            console.log('🔍 DOM 전체 요소 확인:');
            console.log('- total-accounts-card:', document.getElementById('total-accounts-card'));
            console.log('- total-properties-card:', document.getElementById('total-properties-card'));
            console.log('- active-users-card:', document.getElementById('active-users-card'));
            console.log('- expiring-soon-card:', document.getElementById('expiring-soon-card'));
            
            // 모든 card 관련 요소 찾기
            const allElements = document.querySelectorAll('*');
            const cardElements = Array.from(allElements).filter(el => el.id && el.id.includes('card'));
            console.log('🔍 DOM에서 찾은 모든 card 요소들:', cardElements.map(el => ({id: el.id, text: el.textContent.trim()})));
            
            // 각 카드별로 상세 디버깅
            const cardUpdates = [
                { id: 'total-accounts-card', value: totalAccounts, name: '총 계정' },
                { id: 'total-properties-card', value: totalProperties, name: '총 프로퍼티' },
                { id: 'active-users-card', value: activeUsers, name: '활성 사용자' },
                { id: 'expiring-soon-card', value: expiringSoon, name: '만료 예정' }
            ];
            
            cardUpdates.forEach(card => {
                console.log(`🔍 ${card.name} 카드 업데이트 시도 - ID: ${card.id}, 값: ${card.value}`);
                const element = document.getElementById(card.id);
                console.log(`🔍 ${card.name} DOM 요소:`, element);
                
                if (element) {
                    const currentValue = element.textContent;
                    console.log(`🔍 ${card.name} 현재 값: "${currentValue}"`);
                    element.textContent = card.value;
                    console.log(`✅ ${card.name} 카드 업데이트 성공: ${currentValue} → ${card.value}`);
                } else {
                    console.error(`❌ ${card.name} 카드 요소를 찾을 수 없음 - ID: ${card.id}`);
                }
            });
            
            // 시스템 정보 섹션 업데이트
            updateElement('total-accounts', totalAccounts);
            updateElement('total-properties', totalProperties);
            updateElement('active-users', activeUsers);
            updateElement('expiring-soon', expiringSoon);
            updateElement('total-notifications', stats.total_notifications || 0);
            updateElement('total-audit-logs', stats.total_audit_logs || 0);
            updateElement('total-registrations', stats.total_registrations || 0);
            
            console.log('✅ 시스템 정보 업데이트 완료');
        } else {
            console.error('❌ 잘못된 응답 데이터:', data);
        }
        
        // 로딩 표시 숨기기
        loadingElements.forEach(el => el.style.display = 'none');
        
        console.log('✅ 통계 새로고침 완료 - 모든 요소 업데이트됨');
        
    } catch (error) {
        console.error('❌ 통계 새로고침 실패:', error);
        
        // 로딩 표시 숨기기
        const loadingElements = document.querySelectorAll('.loading-indicator');
        loadingElements.forEach(el => el.style.display = 'none');
        
        // 오류 시에는 기존 값 유지 (undefined로 변경하지 않음)
        console.log('🔄 오류 발생으로 기존 값 유지');
    }
}

// 메일 전송 이력 관리 함수들
async function refreshNotificationLogs() {
    try {
        console.log('📧 메일 전송 이력 새로고침 시작...');
        
        const container = document.getElementById('notification-logs-container');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">로딩 중...</span>
                </div>
            </div>
        `;
        
        const response = await fetch('/api/notification-logs');
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || '데이터 로드 실패');
        }
        
        const logs = data.data.logs;
        
        if (logs.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle"></i> 메일 전송 이력이 없습니다.
                </div>
            `;
            return;
        }
        
        // 테이블 생성
        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>상태</th>
                            <th>이메일</th>
                            <th>알림 타입</th>
                            <th>제목</th>
                            <th>발송 시간</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        logs.forEach(log => {
            const formattedDate = new Date(log.sent_at).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const typeMap = {
                'welcome': '환영',
                'expiry_warning_30': '만료 30일전',
                'expiry_warning_7': '만료 7일전',
                'expiry_warning_1': '만료 1일전',
                'expired': '만료 알림',
                'admin': '관리자',
                'editor_downgrade': 'Editor 다운그레이드',
                'admin_downgrade': 'Admin 다운그레이드',
                'admin_approved': 'Admin 승인'
            };
            
            tableHtml += `
                <tr>
                    <td><span style="font-size: 1.2em;">${log.status_icon}</span></td>
                    <td><code>${log.user_email}</code></td>
                    <td><span class="badge bg-secondary">${typeMap[log.notification_type] || log.notification_type}</span></td>
                    <td>${log.subject || '-'}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearSpecificEmailLogs('${log.user_email}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tableHtml += `
                    </tbody>
                </table>
            </div>
            <div class="mt-3 text-muted">
                <small>총 ${logs.length}개의 메일 전송 이력 (최근 100개)</small>
            </div>
        `;
        
        container.innerHTML = tableHtml;
        console.log('✅ 메일 전송 이력 로드 완료');
        
    } catch (error) {
        console.error('❌ 메일 전송 이력 로드 실패:', error);
        document.getElementById('notification-logs-container').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 메일 전송 이력을 불러오는데 실패했습니다: ${error.message}
            </div>
        `;
    }
}

async function clearAllNotificationLogs() {
    if (!confirm('⚠️ 모든 메일 전송 이력을 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
        return;
    }
    
    try {
        showLoading('전체 메일 이력 삭제 중...');
        
        const response = await fetch('/api/notification-logs', {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || '삭제 실패');
        }
        
        showAlert('success', data.message);
        await refreshNotificationLogs();
        
    } catch (error) {
        console.error('❌ 전체 메일 이력 삭제 실패:', error);
        showAlert('danger', `전체 메일 이력 삭제 실패: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function clearTodayNotificationLogs() {
    if (!confirm('⚠️ 오늘 날짜의 메일 전송 이력을 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        showLoading('오늘 메일 이력 삭제 중...');
        
        const response = await fetch('/api/notification-logs/today', {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || '삭제 실패');
        }
        
        showAlert('success', data.message);
        await refreshNotificationLogs();
        
    } catch (error) {
        console.error('❌ 오늘 메일 이력 삭제 실패:', error);
        showAlert('danger', `오늘 메일 이력 삭제 실패: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function clearSpecificEmailLogs(email) {
    // 함수 매개변수로 받은 이메일이 없으면 입력 필드에서 가져오기
    if (!email) {
        email = document.getElementById('specificEmail').value.trim();
    }
    
    if (!email) {
        showAlert('warning', '삭제할 이메일 주소를 입력해주세요.');
        return;
    }
    
    if (!confirm(`⚠️ ${email}의 메일 전송 이력을 삭제하시겠습니까?`)) {
        return;
    }
    
    try {
        showLoading(`${email} 메일 이력 삭제 중...`);
        
        const response = await fetch(`/api/notification-logs/${encodeURIComponent(email)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || '삭제 실패');
        }
        
        showAlert('success', data.message);
        await refreshNotificationLogs();
        
        // 입력 필드 초기화
        const inputField = document.getElementById('specificEmail');
        if (inputField) {
            inputField.value = '';
        }
        
    } catch (error) {
        console.error('❌ 특정 이메일 메일 이력 삭제 실패:', error);
        showAlert('danger', `특정 이메일 메일 이력 삭제 실패: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// 만료 사용자 처리 함수
async function processExpiredUsers() {
    if (!confirm('⚠️ 만료된 사용자를 삭제하고 알림을 발송하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
        return;
    }
    
    try {
        showLoading('만료 사용자 처리 중...');
        
        const response = await fetch('/api/process-expired-users', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || '만료 사용자 처리 실패');
        }
        
        const results = data.data;
        const message = `만료 사용자 처리 완료\n처리: ${results.processed}명\n발송: ${results.sent}명\n실패: ${results.failed}명\n건너뜀: ${results.skipped}명`;
        
        showAlert('success', message);
        
        // 메일 전송 이력과 통계 새로고림
        setTimeout(async () => {
            await refreshNotificationLogs();
            await refreshStats();
        }, 1000);
        
    } catch (error) {
        console.error('❌ 만료 사용자 처리 실패:', error);
        showAlert('danger', `만료 사용자 처리 실패: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// 테스트 알림 모달 표시 함수
function showTestNotificationModal() {
    const modal = new bootstrap.Modal(document.getElementById('testNotificationModal'));
    modal.show();
}

// Editor 승인 관련 함수들
function showEditorApprovalModal() {
    const modal = new bootstrap.Modal(document.getElementById('editorApprovalModal'));
    modal.show();
}

async function executeEditorApproval() {
    const email = document.getElementById('editorApprovalEmail').value.trim();
    const type = document.getElementById('editorApprovalType').value;
    
    if (!email) {
        showAlert('warning', '이메일 주소를 입력해주세요.');
        return;
    }
    
    try {
        showLoading('Editor 승인 처리 중...');
        
        // 모달 닫기
        const modal = bootstrap.Modal.getInstance(document.getElementById('editorApprovalModal'));
        if (modal) {
            modal.hide();
        }
        
        let endpoint = type === 'real' ? '/api/approve-editor' : '/api/test-editor-approval';
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: email
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Editor 승인 처리 실패');
        }
        
        const message = type === 'real' 
            ? `Editor 권한 승인 완료!\n사용자: ${email}\n만료일: ${data.data.expiry_date}\n승인 메일: ${data.data.approval_notification_sent ? '발송됨' : '실패'}\n환영 메일: ${data.data.welcome_notification_sent ? '발송됨' : '실패'}`
            : `Editor 승인 테스트 메일 발송 완료!\n사용자: ${email}\n메일 발송: ${data.data.notification_sent ? '성공' : '실패'}`;
        
        showAlert('success', message);
        
        // 메일 전송 이력 새로고침
        setTimeout(async () => {
            await refreshNotificationLogs();
            if (type === 'real') {
                await refreshStats();
            }
        }, 1000);
        
    } catch (error) {
        console.error('❌ Editor 승인 처리 실패:', error);
        showAlert('danger', `Editor 승인 처리 실패: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function viewPendingEditorRequests() {
    try {
        const modal = new bootstrap.Modal(document.getElementById('pendingRequestsModal'));
        modal.show();
        
        await loadPendingRequests();
        
    } catch (error) {
        console.error('❌ 승인 대기 목록 조회 실패:', error);
        showAlert('danger', `승인 대기 목록 조회 실패: ${error.message}`);
    }
}

async function loadPendingRequests() {
    try {
        const container = document.getElementById('pending-requests-container');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">로딩 중...</span>
                </div>
            </div>
        `;
        
        const response = await fetch('/api/pending-editor-requests');
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || '승인 대기 목록 조회 실패');
        }
        
        const requests = data.data.requests;
        
        if (requests.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 승인 대기 중인 Editor 요청이 없습니다.
                </div>
            `;
            return;
        }
        
        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>신청자</th>
                            <th>사용자 이메일</th>
                            <th>프로퍼티</th>
                            <th>신청일</th>
                            <th>사유</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        requests.forEach(request => {
            const createdDate = new Date(request.created_at);
            const formattedDate = createdDate.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            tableHtml += `
                <tr>
                    <td>${request.applicant || '-'}</td>
                    <td><code>${request.user_email}</code></td>
                    <td>${request.property_name}</td>
                    <td>${formattedDate}</td>
                    <td>${request.reason || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-success me-1" onclick="approveEditorFromList('${request.user_email}', '${request.property_id}')">
                            승인
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="rejectEditorFromList('${request.user_email}', '${request.property_id}')">
                            거부
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tableHtml += `
                    </tbody>
                </table>
            </div>
            <div class="mt-3 text-muted">
                <small>총 ${requests.length}개의 승인 대기 요청</small>
            </div>
        `;
        
        container.innerHTML = tableHtml;
        
    } catch (error) {
        console.error('❌ 승인 대기 목록 로드 실패:', error);
        document.getElementById('pending-requests-container').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 승인 대기 목록을 불러오는데 실패했습니다: ${error.message}
            </div>
        `;
    }
}

async function approveEditorFromList(userEmail, propertyId) {
    if (!confirm(`${userEmail}의 Editor 권한을 승인하시겠습니까?`)) {
        return;
    }
    
    try {
        showLoading('Editor 권한 승인 중...');
        
        const response = await fetch('/api/approve-editor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: userEmail,
                property_id: propertyId
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Editor 권한 승인 실패');
        }
        
        showAlert('success', `${userEmail}의 Editor 권한이 승인되었습니다.`);
        
        // 목록 새로고침
        await loadPendingRequests();
        await refreshNotificationLogs();
        
    } catch (error) {
        console.error('❌ Editor 권한 승인 실패:', error);
        showAlert('danger', `Editor 권한 승인 실패: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function rejectEditorFromList(userEmail, propertyId) {
    if (!confirm(`${userEmail}의 Editor 권한 요청을 거부하시겠습니까?`)) {
        return;
    }
    
    // TODO: 거부 API 구현 필요
    showAlert('info', 'Editor 권한 거부 기능은 아직 구현되지 않았습니다.');
}

async function testEditorApprovalFlow() {
    if (!confirm('완전한 Editor 승인 플로우를 테스트하시겠습니까?\n테스트 사용자로 전체 과정을 시뮬레이션합니다.')) {
        return;
    }
    
    try {
        showLoading('완전한 승인 플로우 테스트 중...');
        
        const testEmail = 'complete_test@example.com';
        
        // 1단계: Editor 승인 테스트
        const approvalResponse = await fetch('/api/test-editor-approval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: testEmail
            })
        });
        
        const approvalData = await approvalResponse.json();
        
        if (!approvalResponse.ok || !approvalData.success) {
            throw new Error('승인 메일 발송 실패');
        }
        
        // 2단계: Welcome 메일 발송
        const welcomeResponse = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: testEmail,
                notification_type: 'welcome'
            })
        });
        
        const welcomeData = await welcomeResponse.json();
        
        if (!welcomeResponse.ok || !welcomeData.success) {
            throw new Error('환영 메일 발송 실패');
        }
        
        // 3단계: 7일 만료 경고 메일 발송
        const warningResponse = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: testEmail,
                notification_type: 'expiry_warning_7'
            })
        });
        
        const warningData = await warningResponse.json();
        
        // 4단계: 삭제 알림 발송 (선택적)
        const deletionResponse = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: testEmail,
                notification_type: 'deletion_notice'
            })
        });
        
        const deletionData = await deletionResponse.json();
        
        const message = `완전한 Editor 승인 플로우 테스트 완료!\n\n테스트 이메일: ${testEmail}\n\n결과:\n✅ Editor 승인 메일: ${approvalData.data.notification_sent ? '성공' : '실패'}\n✅ 환영 메일: ${welcomeData.success ? '성공' : '실패'}\n✅ 7일 만료 경고: ${warningData.success ? '성공' : '실패'}\n✅ 삭제 알림: ${deletionData.success ? '성공' : '실패'}`;
        
        showAlert('success', message);
        
        // 메일 전송 이력 새로고침
        setTimeout(async () => {
            await refreshNotificationLogs();
        }, 1000);
        
    } catch (error) {
        console.error('❌ 완전한 승인 플로우 테스트 실패:', error);
        showAlert('danger', `완전한 승인 플로우 테스트 실패: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// Admin 승인 관련 함수들
function showAdminApprovalModal() {
    const modal = new bootstrap.Modal(document.getElementById('adminApprovalModal'));
    modal.show();
}

async function executeAdminApproval() {
    const email = document.getElementById('adminApprovalEmail').value.trim();
    const type = document.getElementById('adminApprovalType').value;
    
    if (!email) {
        showAlert('warning', '이메일 주소를 입력해주세요.');
        return;
    }
    
    if (!confirm(`${email}에게 Admin 권한을 ${type === 'real' ? '실제로' : '테스트'} 승인하시겠습니까?\nAdmin 권한은 최고 권한입니다.`)) {
        return;
    }
    
    try {
        showLoading('Admin 승인 처리 중...');
        
        // 모달 닫기
        const modal = bootstrap.Modal.getInstance(document.getElementById('adminApprovalModal'));
        if (modal) {
            modal.hide();
        }
        
        let endpoint = type === 'real' ? '/api/approve-admin' : '/api/test-admin-approval';
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: email
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Admin 승인 처리 실패');
        }
        
        const message = type === 'real' 
            ? `Admin 권한 승인 완료!\n사용자: ${email}\n만료일: ${data.data.expiry_date}\n승인 메일: ${data.data.approval_notification_sent ? '발송됨' : '실패'}\n환영 메일: ${data.data.welcome_notification_sent ? '발송됨' : '실패'}`
            : `Admin 승인 테스트 메일 발송 완료!\n사용자: ${email}\n메일 발송: ${data.data.notification_sent ? '성공' : '실패'}`;
        
        showAlert('success', message);
        
        // 메일 전송 이력 새로고침
        setTimeout(async () => {
            await refreshNotificationLogs();
            if (type === 'real') {
                await refreshStats();
            }
        }, 1000);
        
    } catch (error) {
        console.error('❌ Admin 승인 처리 실패:', error);
        showAlert('danger', `Admin 승인 처리 실패: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function viewPendingAdminRequests() {
    try {
        const modal = new bootstrap.Modal(document.getElementById('pendingAdminRequestsModal'));
        modal.show();
        
        await loadPendingAdminRequests();
        
    } catch (error) {
        console.error('❌ Admin 승인 대기 목록 조회 실패:', error);
        showAlert('danger', `Admin 승인 대기 목록 조회 실패: ${error.message}`);
    }
}

async function loadPendingAdminRequests() {
    try {
        const container = document.getElementById('pending-admin-requests-container');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">로딩 중...</span>
                </div>
            </div>
        `;
        
        const response = await fetch('/api/pending-admin-requests');
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Admin 승인 대기 목록 조회 실패');
        }
        
        const requests = data.data.requests;
        
        if (requests.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 승인 대기 중인 Admin 요청이 없습니다.
                </div>
            `;
            return;
        }
        
        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="table-danger">
                        <tr>
                            <th>신청자</th>
                            <th>사용자 이메일</th>
                            <th>프로퍼티</th>
                            <th>신청일</th>
                            <th>사유</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        requests.forEach(request => {
            const createdDate = new Date(request.created_at);
            const formattedDate = createdDate.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            tableHtml += `
                <tr>
                    <td>${request.applicant || '-'}</td>
                    <td><code>${request.user_email}</code></td>
                    <td>${request.property_name}</td>
                    <td>${formattedDate}</td>
                    <td><span class="badge bg-danger">${request.reason || 'Admin 권한 신청'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger me-1" onclick="approveAdminFromList('${request.user_email}', '${request.property_id}')">
                            승인
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="rejectAdminFromList('${request.user_email}', '${request.property_id}')">
                            거부
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tableHtml += `
                    </tbody>
                </table>
            </div>
            <div class="mt-3 text-muted">
                <small>총 ${requests.length}개의 Admin 승인 대기 요청 (최고 권한)</small>
            </div>
        `;
        
        container.innerHTML = tableHtml;
        
    } catch (error) {
        console.error('❌ Admin 승인 대기 목록 로드 실패:', error);
        document.getElementById('pending-admin-requests-container').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Admin 승인 대기 목록을 불러오는데 실패했습니다: ${error.message}
            </div>
        `;
    }
}

async function approveAdminFromList(userEmail, propertyId) {
    if (!confirm(`${userEmail}에게 Admin 권한을 승인하시겠습니까?\n\n⚠️ 주의: Admin 권한은 최고 권한으로 모든 작업이 가능합니다.`)) {
        return;
    }
    
    try {
        showLoading('Admin 권한 승인 중...');
        
        const response = await fetch('/api/approve-admin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: userEmail,
                property_id: propertyId
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Admin 권한 승인 실패');
        }
        
        showAlert('success', `${userEmail}의 Admin 권한이 승인되었습니다.`);
        
        // 목록 새로고침
        await loadPendingAdminRequests();
        await refreshNotificationLogs();
        
    } catch (error) {
        console.error('❌ Admin 권한 승인 실패:', error);
        showAlert('danger', `Admin 권한 승인 실패: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function rejectAdminFromList(userEmail, propertyId) {
    if (!confirm(`${userEmail}의 Admin 권한 요청을 거부하시겠습니까?`)) {
        return;
    }
    
    // TODO: 거부 API 구현 필요
    showAlert('info', 'Admin 권한 거부 기능은 아직 구현되지 않았습니다.');
}

async function testAdminApprovalFlow() {
    if (!confirm('완전한 Admin 승인 플로우를 테스트하시겠습니까?\n⚠️ Admin 권한은 최고 권한입니다.')) {
        return;
    }
    
    try {
        showLoading('완전한 Admin 승인 플로우 테스트 중...');
        
        const testEmail = 'admin_test@example.com';
        
        // 1단계: Admin 승인 테스트
        const approvalResponse = await fetch('/api/test-admin-approval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_email: testEmail
            })
        });
        
        const approvalData = await approvalResponse.json();
        
        if (!approvalResponse.ok || !approvalData.success) {
            throw new Error('Admin 승인 메일 발송 실패');
        }
        
        // 2단계: Welcome 메일 발송
        const welcomeResponse = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: testEmail,
                notification_type: 'welcome'
            })
        });
        
        const welcomeData = await welcomeResponse.json();
        
        // 3단계: Admin 알림 발송 (중요 알림)
        const adminNotificationResponse = await fetch('/api/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: testEmail,
                notification_type: 'admin'
            })
        });
        
        const adminNotificationData = await adminNotificationResponse.json();
        
        const message = `완전한 Admin 승인 플로우 테스트 완료!\n\n테스트 이메일: ${testEmail}\n\n결과:\n✅ Admin 승인 메일: ${approvalData.data.notification_sent ? '성공' : '실패'}\n✅ 환영 메일: ${welcomeData.success ? '성공' : '실패'}\n✅ Admin 중요 알림: ${adminNotificationData.success ? '성공' : '실패'}\n\n⚠️ Admin 권한은 7일 후 자동으로 Viewer로 다운그레이드됩니다.`;
        
        showAlert('success', message);
        
        // 메일 전송 이력 새로고침
        setTimeout(async () => {
            await refreshNotificationLogs();
        }, 1000);
        
    } catch (error) {
        console.error('❌ 완전한 Admin 승인 플로우 테스트 실패:', error);
        showAlert('danger', `완전한 Admin 승인 플로우 테스트 실패: ${error.message}`);
    } finally {
        hideLoading();
    }
}

</script>
{% endblock %} 